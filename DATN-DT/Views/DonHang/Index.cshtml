@model DATN_DT.Controllers.OrderViewModel
@{
    ViewData["Title"] = "Bán Hàng";
}

<style>
    /* Chỉ áp dụng cho trang bán hàng */
    .order-page .card-header {
        padding: 0.6rem 1rem;
    }

    .order-page .card-body {
        padding: 0.9rem 1rem;
    }

    .order-page .card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .order-page .product-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        transition: box-shadow 0.2s;
    }

    .order-page #searchResults .list-group-item {
        border-radius: 6px;
        margin-bottom: 6px;
    }

    .order-page #modelResults .card {
        border: 1px solid #e9ecef;
    }

    .order-page #selectedProductsTable th,
    .order-page #selectedProductsTable td {
        vertical-align: middle;
    }

    .order-page #selectedProductsTable img {
        border-radius: 6px;
    }

    .order-page .table thead th {
        background: #f6f7fb;
    }

    .order-page .summary-label {
        font-size: 0.95rem;
        color: #555;
    }

    .order-page .summary-value {
        font-weight: 700;
    }

    .order-page .btn + .btn {
        margin-left: 6px;
    }
</style>

<div class="container-fluid order-page">
    <h2>Bán Hàng</h2>
    <hr />

    <div class="row">
        <!-- Bên trái: Thông tin khách hàng và tìm kiếm sản phẩm -->
        <div class="col-md-8">
            <!-- Phần chọn khách hàng -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-user"></i> Thông Tin Khách Hàng
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="small">Khách Hàng Thân Thiết</label>
                            <select id="khachHangSelect" class="form-control form-control-sm">
                                <option value="">-- Chọn khách hàng --</option>
                                @foreach (var kh in Model.KhachHangList)
                                {
                                    <option value="@kh.IdKhachHang" data-diem="@kh.DiemTichLuy">
                                        @kh.HoTenKhachHang - @kh.SdtKhachHang
                                    </option>
                                }
                            </select>
                            <small id="diemTichLuy" class="text-success"></small>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="small">Hoặc Khách Vãng Lai</label>
                            <button type="button" class="btn btn-outline-secondary btn-block btn-sm" onclick="setKhachVangLai()">
                                Khách Vãng Lai
                            </button>
                            <input type="hidden" id="idKhachHang" value="" />
                        </div>
                    </div>
                    <div class="mt-2 row">
                        <div class="col-md-6 mb-2">
                            <input type="text" id="tenKhachHang" class="form-control form-control-sm" placeholder="Tên khách hàng" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <input type="text" id="sdtKhachHang" class="form-control form-control-sm" placeholder="Số điện thoại" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phần tìm kiếm sản phẩm -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-search"></i> Tìm Kiếm Sản Phẩm
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="searchProduct" class="form-control" placeholder="Nhập tên sản phẩm để tìm kiếm..." />
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="searchProducts()">
                                <i class="fas fa-search"></i> Tìm
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="resetSearch()">
                                <i class="fas fa-undo"></i> Đặt lại
                            </button>
                        </div>
                    </div>
                    <div id="searchResults" class="mt-3">
                        <!-- Kết quả tìm kiếm sẽ hiển thị ở đây -->
                    </div>
                    <div id="modelResults" class="mt-3">
                        <!-- Danh sách model theo sản phẩm -->
                    </div>
                </div>
            </div>

            <!-- Phần sản phẩm đã chọn -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-shopping-cart"></i> Sản Phẩm Đã Chọn
                </div>
                <div class="card-body">
                    <table class="table table-bordered" id="selectedProductsTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Ảnh</th>
                                <th>Tên Model</th>
                                <th>Thuộc tính</th>
                                <th>Giá</th>
                                <th>IMEI</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="selectedProductsBody">
                            <!-- Sản phẩm đã chọn sẽ hiển thị ở đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bên phải: Thanh toán -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-money-bill-wave"></i> Thanh Toán
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="small">Phương Thức Thanh Toán</label>
                        <select id="phuongThucTT" class="form-control form-control-sm">
                            <option value="Tiền mặt">Tiền mặt</option>
                            <option value="Chuyển khoản">Chuyển khoản</option>
                            <option value="Thẻ">Thẻ</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="summary-label">Tổng tiền hàng</span>
                            <span id="tongTienHang" class="summary-value text-danger">0 đ</span>
                        </div>
                    </div>

                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="summary-label">Tổng thanh toán</span>
                            <span id="tongThanhToan" class="summary-value text-primary">0 đ</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="small">Số tiền khách đưa</label>
                        <input type="number" id="tienKhachDua" class="form-control form-control-sm" value="0" min="0" />
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="summary-label">Tiền thừa</span>
                            <span id="tienThua" class="summary-value text-info">0 đ</span>
                        </div>
                        <div id="tienThuaWarning" class="alert alert-danger mt-2 mb-0 d-none" style="font-size: 0.85rem; padding: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> Không thanh toán - Số tiền khách đưa chưa đủ!
                        </div>
                    </div>

                    <button class="btn btn-success btn-lg btn-block mb-2" onclick="thanhToan()">
                        <i class="fas fa-check"></i> THANH TOÁN
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chi tiết sản phẩm -->
<div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi Tiết Sản Phẩm</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- Nội dung chi tiết sản phẩm sẽ load ở đây -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedProduct()">Thêm vào hóa đơn</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var selectedProducts = [];
        var currentProductDetail = null;
        var currentProductName = '';
        var virtualInvoicesKey = 'virtualInvoices';

        function renderPrice(value) {
            return Number(value || 0).toLocaleString() + 'đ';
        }


        // Tìm kiếm sản phẩm khi nhấn nút
        function searchProducts() {
            var keyword = $('#searchProduct').val();
            if (!keyword || !keyword.trim()) {
                $('#searchResults').empty();
                $('#modelResults').empty();
                return;
            }

            $.get('@Url.Action("SearchProducts", "DonHang")', { keyword: keyword }, function (response) {
                if (response && response.success && response.data && response.data.length > 0) {
                    var html = '<div class="list-group">';
                    response.data.forEach(function (product) {
                        html += '<button type="button" class="list-group-item list-group-item-action" onclick="selectProduct(' + product.idSanPham + ', \'' + (product.tenSanPham || '').replace(/'/g, "\\'") + '\')">' +
                            '<div class="d-flex w-100 justify-content-between">' +
                                '<h5 class="mb-1">' + product.tenSanPham + '</h5>' +
                                '<small>' + (product.thuongHieu || '') + '</small>' +
                            '</div>' +
                        '</button>';
                    });
                    html += '</div>';
                    $('#searchResults').html(html);
                } else {
                    $('#searchResults').html('<div class="alert alert-info">Không tìm thấy sản phẩm nào</div>');
                    $('#modelResults').empty();
                }
            });
        }

        function resetSearch() {
            $('#searchProduct').val('');
            $('#searchResults').empty();
            $('#modelResults').empty();
            currentProductDetail = null;
            currentProductName = '';
        }

        function selectProduct(productId, productName) {
            currentProductName = productName || '';
            $('#modelResults').html('<div class="text-muted">Đang tải model...</div>');
            $.get('@Url.Action("GetModelsByProduct", "DonHang")', { productId: productId }, function (response) {
                if (response && response.success && response.data && response.data.length > 0) {
                    var html = '<div class="row">';
                    response.data.forEach(function (model) {
                        var img = model.anh ? model.anh : '/images/no-image.png';
                        html += '' +
                            '<div class="col-md-4 mb-3">' +
                                '<div class="card h-100" style="cursor:pointer;" onclick="showModelDetail(' + model.idModelSanPham + ')">' +
                                    '<img class="card-img-top" src="' + img + '" alt="' + model.tenModel + '" onerror="this.src=\'/images/no-image.png\'" style="max-height:180px;object-fit:cover;">' +
                                    '<div class="card-body">' +
                                        '<h6 class="card-title">' + model.tenModel + '</h6>' +
                                        '<p class="card-text mb-1"><strong>Màu:</strong> ' + model.mau + '</p>' +
                                        '<p class="card-text mb-1"><strong>RAM/ROM:</strong> ' + (model.ram || '-') + ' / ' + (model.rom || '-') + '</p>' +
                                        '<p class="card-text mb-1"><strong>Giá:</strong> ' + renderPrice(model.giaBanModel) + '</p>' +
                                        '<p class="card-text"><strong>Tồn:</strong> ' + (model.soLuongTon || 0) + '</p>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                    });
                    html += '</div>';
                    $('#modelResults').html(html);
                } else {
                    $('#modelResults').html('<div class="alert alert-warning">Sản phẩm chưa có model khả dụng.</div>');
                }
            });
        }

        // Hiển thị chi tiết model + IMEI
        function showModelDetail(productId) {
            $.get('@Url.Action("GetProductDetail", "DonHang")', { id: productId }, function (response) {
                if (response && response.success) {
                    currentProductDetail = response.data;

                    var img = currentProductDetail.anh ? currentProductDetail.anh : '/images/no-image.png';
                    var imeiOptions = '<option value="">-- Chọn IMEI --</option>';
                    if (currentProductDetail.imeis && currentProductDetail.imeis.length > 0) {
                        currentProductDetail.imeis.forEach(function (imei) {
                            imeiOptions += '<option value="' + imei.idImei + '">' + imei.maImei + '</option>';
                        });
                    } else {
                        imeiOptions = '<option value="">Không có IMEI khả dụng</option>';
                    }

                    var html = '' +
                        '<div class="row">' +
                            '<div class="col-md-5">' +
                                '<img src="' + img + '" alt="' + currentProductDetail.tenModel + '" class="img-fluid mb-2" onerror="this.src=\'/images/no-image.png\'"/>' +
                            '</div>' +
                            '<div class="col-md-7">' +
                                '<h4>' + (currentProductDetail.tenSanPham || '') + ' - ' + currentProductDetail.tenModel + '</h4>' +
                                '<p><strong>Giá bán: </strong>' + renderPrice(currentProductDetail.giaBanModel) + '</p>' +
                                '<p><strong>Màu sắc: </strong>' + currentProductDetail.tenMau + '</p>' +
                                '<p><strong>RAM/ROM: </strong>' + (currentProductDetail.ram || '-') + ' / ' + (currentProductDetail.rom || '-') + '</p>' +
                                '<p><strong>Số lượng tồn: </strong>' + (currentProductDetail.soLuongTon || 0) + '</p>' +
                                '<div class="form-group">' +
                                    '<label>Chọn IMEI</label>' +
                                    '<select id="modalImeiSelect" class="form-control">' +
                                        imeiOptions +
                                    '</select>' +
                                '</div>' +
                            '</div>' +
                        '</div>';

                    $('#productDetailContent').html(html);
                    $('#productDetailModal').modal('show');
                } else {
                    alert('Không tìm thấy thông tin sản phẩm');
                }
            });
        }

        // Thêm sản phẩm đã chọn vào hóa đơn
        function addSelectedProduct() {
            if (!currentProductDetail) return;

            var selectedImei = $('#modalImeiSelect').val();
            if (currentProductDetail.imeis && currentProductDetail.imeis.length > 0 && !selectedImei) {
                alert('Vui lòng chọn IMEI');
                return;
            }

            if (selectedImei) {
                var imeiDup = selectedProducts.some(function (p) {
                    return p.selectedImeis && p.selectedImeis.indexOf(parseInt(selectedImei)) !== -1;
                });
                if (imeiDup) {
                    alert('IMEI này đã được chọn trong đơn!');
                    return;
                }
            }

            var selectedImeiObj = null;
            if (selectedImei && currentProductDetail.imeis) {
                selectedImeiObj = currentProductDetail.imeis.find(function (i) { return i.idImei == selectedImei; });
            }

            var product = {
                idModelSanPham: currentProductDetail.idModelSanPham,
                idSanPham: currentProductDetail.idSanPham,
                tenModel: currentProductDetail.tenModel,
                tenSanPham: currentProductDetail.tenSanPham,
                giaBanModel: currentProductDetail.giaBanModel,
                tenMau: currentProductDetail.tenMau,
                soLuongTon: currentProductDetail.soLuongTon,
                soLuong: 1,
                imeis: currentProductDetail.imeis || [],
                selectedImeis: selectedImei ? [parseInt(selectedImei)] : [],
                maImei: selectedImeiObj ? selectedImeiObj.maImei : '',
                ram: currentProductDetail.ram,
                rom: currentProductDetail.rom,
                anh: currentProductDetail.anh
            };

            selectedProducts.push(product);
            renderSelectedProducts();
            $('#productDetailModal').modal('hide');
        }

        // Cập nhật IMEI khi chọn trong bảng
        $('#selectedProductsBody').on('change', '.imei-select', function () {
            var index = parseInt($(this).data('index'));
            var imeiId = $(this).val();
            var product = selectedProducts[index];
            if (!product) return;

            if (imeiId) {
                var imeiNumber = parseInt(imeiId);
                var duplicate = selectedProducts.some(function (p, idx) {
                    if (idx === index) return false;
                    return p.selectedImeis && p.selectedImeis.indexOf(imeiNumber) !== -1;
                });
                if (duplicate) {
                    alert('IMEI này đã được chọn cho sản phẩm khác.');
                    $(this).val(product.selectedImeis.length ? product.selectedImeis[0] : '');
                    return;
                }
            }

            if (!imeiId) {
                product.selectedImeis = [];
                product.maImei = '';
            } else {
                var imeiIdNumber = parseInt(imeiId);
                product.selectedImeis = [imeiIdNumber];
                var imeiObj = (product.imeis || []).find(function (i) { return i.idImei === imeiIdNumber; });
                product.maImei = imeiObj ? imeiObj.maImei : '';
            }

            // cập nhật lại hiển thị và tổng tiền sau khi đổi IMEI
            renderSelectedProducts();
        });

        // Hiển thị danh sách sản phẩm đã chọn
        function renderSelectedProducts() {
            var tbody = $('#selectedProductsBody');
            tbody.empty();

            var total = 0;

            selectedProducts.forEach(function (product, index) {
                var rowTotal = Number(product.giaBanModel || 0) * Number(product.soLuong || 0);
                total += rowTotal;

                var imeiDisplay = product.maImei || 'Chưa chọn IMEI';

                var tonDisplay = product.soLuongTon != null ? product.soLuongTon : 0;

                var row = '' +
                    '<tr id="selected_' + index + '">' +
                        '<td>' + (index + 1) + '</td>' +
                        '<td><img src="' + (product.anh || '/images/no-image.png') + '" alt="img" style="width:60px;height:60px;object-fit:cover;" onerror="this.src=\'/images/no-image.png\'"/></td>' +
                        '<td>' + (product.tenSanPham || '') + ' - ' + product.tenModel + '</td>' +
                        '<td>' +
                            '<div><strong>Màu: </strong>' + (product.tenMau || 'N/A') + '</div>' +
                            '<div><strong>RAM/ROM: </strong>' + (product.ram || '-') + ' / ' + (product.rom || '-') + '</div>' +
                            '<div><strong>Tồn: </strong>' + tonDisplay + '</div>' +
                        '</td>' +
                        '<td>' + renderPrice(product.giaBanModel) + '</td>' +
                        '<td><span>' + imeiDisplay + '</span></td>' +
                        '<td>' +
                            '<button class="btn btn-danger btn-sm" onclick="removeSelectedProduct(' + index + ')">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</td>' +
                    '</tr>';
                tbody.append(row);
            });

            calculatePayment(total);
        }

        function removeSelectedProduct(index) {
            selectedProducts.splice(index, 1);
            renderSelectedProducts();
        }

        function calculatePayment(total) {
            var thanhToan = total;
            var tienKhachDua = parseFloat($('#tienKhachDua').val()) || 0;
            // Tiền thừa = Số tiền khách đưa - Tổng thanh toán
            var tienThua = tienKhachDua - thanhToan;

            $('#tongTienHang').text(renderPrice(total));
            $('#tongThanhToan').text(renderPrice(thanhToan));
            
            // Hiển thị tiền thừa
            if (tienThua >= 0) {
                $('#tienThua').text(tienThua.toLocaleString() + ' đ').removeClass('text-danger').addClass('text-info');
                $('#tienThuaWarning').addClass('d-none');
            } else {
                // Nếu tiền thừa âm (khách trả chưa đủ)
                $('#tienThua').text(Math.abs(tienThua).toLocaleString() + ' đ (thiếu)').removeClass('text-info').addClass('text-danger');
                $('#tienThuaWarning').removeClass('d-none');
            }
        }

        function setKhachVangLai() {
            $('#khachHangSelect').val('');
            $('#idKhachHang').val('');
            $('#diemTichLuy').text('');
            $('#tenKhachHang').val('').prop('disabled', false);
            $('#sdtKhachHang').val('').prop('disabled', false);
        }

        function thanhToan() {
            if (selectedProducts.length === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm');
                return;
            }

            var hasMissingImei = selectedProducts.some(function (p) { return !p.selectedImeis || p.selectedImeis.length === 0; });
            if (hasMissingImei) {
                alert('Vui lòng chọn IMEI cho tất cả sản phẩm trước khi thanh toán');
                return;
            }

            // Kiểm tra số tiền khách đưa có đủ không
            var tongThanhToan = parseFloat($('#tongThanhToan').text().replace(/[^0-9]/g, '')) || 0;
            var tienKhachDua = parseFloat($('#tienKhachDua').val()) || 0;
            // Tiền thừa = Số tiền khách đưa - Tổng thanh toán
            var tienThua = tienKhachDua - tongThanhToan;
            
            if (tienThua < 0) {
                alert('Không thanh toán - Số tiền khách đưa chưa đủ! Còn thiếu: ' + Math.abs(tienThua).toLocaleString() + ' đ');
                return;
            }

            var orderData = {
                IdKhachHang: $('#khachHangSelect').val() || null,
                TenKhachHang: $('#tenKhachHang').val() || '',
                SdtKhachHang: $('#sdtKhachHang').val() || '',
                DiaChiGiaoHang: '',
                PhuongThucThanhToan: $('#phuongThucTT').val(),
                ChiTietDonHang: selectedProducts.map(function (p) {
                    return {
                        IdModelSanPham: p.idModelSanPham,
                        SoLuong: p.soLuong,
                        SelectedImeis: p.selectedImeis
                    };
                })
            };

            $.post('@Url.Action("Create", "DonHang")', orderData, function (response) {
                if (response && response.success) {
                    alert('Thanh toán thành công!\nMã đơn: ' + response.maDon + '\nNgày bảo hành: ' + response.ngayBaoHanh);
                    location.reload();
                } else {
                    alert('Lỗi: ' + (response ? response.message : 'Không xác định'));
                }
            });
        }

        function saveVirtualInvoice(data) {
            var list = [];
            try { list = JSON.parse(localStorage.getItem(virtualInvoicesKey)) || []; } catch (e) { list = []; }
            list.push(data);
            localStorage.setItem(virtualInvoicesKey, JSON.stringify(list));
        }

        function viewVirtualInvoice(index) {
            var list = [];
            try { list = JSON.parse(localStorage.getItem(virtualInvoicesKey)) || []; } catch (e) { list = []; }
            if (!list[index]) return;
            var html = list[index].html || '';
            var printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
        }

        $(document).ready(function () {
            $('#tienKhachDua').on('input', function() {
                var tongThanhToan = parseFloat($('#tongThanhToan').text().replace(/[^0-9]/g, '')) || 0;
                var tienKhachDua = parseFloat($(this).val()) || 0;
                // Tiền thừa = Số tiền khách đưa - Tổng thanh toán
                var tienThua = tienKhachDua - tongThanhToan;
                
                if (tienThua >= 0) {
                    $('#tienThua').text(tienThua.toLocaleString() + ' đ').removeClass('text-danger').addClass('text-info');
                    $('#tienThuaWarning').addClass('d-none');
                } else {
                    // Nếu tiền thừa âm (khách trả chưa đủ)
                    $('#tienThua').text(Math.abs(tienThua).toLocaleString() + ' đ (thiếu)').removeClass('text-info').addClass('text-danger');
                    $('#tienThuaWarning').removeClass('d-none');
                }
            });

            $('#khachHangSelect').on('change', function () {
                var diem = $(this).find('option:selected').data('diem');
                $('#diemTichLuy').text('Điểm: ' + (diem || 0));
                $('#idKhachHang').val($(this).val());
                var selectedText = $(this).find('option:selected').text() || '';
                var parts = selectedText.split(' - ');
                $('#tenKhachHang').val(parts[0] || '').prop('disabled', !!$(this).val());
                $('#sdtKhachHang').val(parts[1] || '').prop('disabled', !!$(this).val());
            });

            $('#searchProduct').keypress(function (e) {
                if (e.which === 13) {
                    searchProducts();
                }
            });

            // Đảm bảo nút đóng modal hoạt động
            $('#productDetailModal').on('click', '.close, [data-dismiss="modal"]', function () {
                $('#productDetailModal').modal('hide');
            });

        });

        // Expose functions for inline onclick
        window.searchProducts = searchProducts;
        window.showModelDetail = showModelDetail;
        window.addSelectedProduct = addSelectedProduct;
        window.removeSelectedProduct = removeSelectedProduct;
        window.selectProduct = selectProduct;
    </script>
}