@model DATN_DT.Controllers.OrderViewModel
@{
    ViewData["Title"] = "Bán Hàng";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Đơn Hàng - Bán Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-sidebar: #1e293b;
            --bg-header: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            color: var(--text-primary);
            padding-top: 0;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            min-height: calc(100vh - 70px);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Cards */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
            border-bottom: none;
        }

        .card-header.bg-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .card-header.bg-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
        }

        .card-header.bg-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        }

        .card-header.bg-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white;
        }

        .card-body {
            background-color: var(--bg-card);
            color: var(--text-primary);
            padding: 20px;
        }

        /* Form Controls */
        .form-control, .form-select {
            background-color: #1e293b;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 15px;
        }

        .form-control:focus, .form-select:focus {
            background-color: #1e293b;
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        .form-control:disabled {
            background-color: #334155;
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .form-label, label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        small {
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, var(--primary-hover) 0%, #7c3aed 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            border: none;
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            border: none;
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-outline-secondary {
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            background: transparent;
        }

        .btn-outline-secondary:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        /* Table */
        .table {
            background-color: transparent;
            color: var(--text-primary);
        }

        .table thead th {
            background: linear-gradient(135deg, var(--bg-header) 0%, #0f172a 100%);
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            padding: 15px;
        }

        .table tbody td {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 15px;
        }

        .table tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .table-bordered {
            border: 1px solid var(--border-color);
        }

        /* List Group */
        .list-group-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .list-group-item:hover {
            background-color: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
        }

        .list-group-item-action {
            cursor: pointer;
        }

        /* Alerts */
        .alert {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .alert-info {
            background-color: rgba(14, 165, 233, 0.1);
            border-color: #0ea5e9;
            color: #7dd3fc;
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            border-color: var(--warning-color);
            color: #fcd34d;
        }

        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--danger-color);
            color: #fca5a5;
        }

        /* Summary Labels */
        .summary-label {
            color: var(--text-secondary);
        font-size: 0.95rem;
    }

        .summary-value {
        font-weight: 700;
            font-size: 1.1rem;
        }

        .text-success {
            color: var(--success-color) !important;
        }

        .text-danger {
            color: var(--danger-color) !important;
        }

        .text-primary {
            color: var(--primary-color) !important;
        }

        .text-info {
            color: #0ea5e9 !important;
        }

        .text-muted {
            color: var(--text-secondary) !important;
        }

        /* Modal */
        .modal-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-card);
        }

        .btn-close-white {
            filter: invert(1);
        }

        /* Product Cards */
        .product-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-color);
        }

        .product-card .card-img-top {
            width: 100%;
            height: 250px;
            object-fit: contain;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 15px;
            border-bottom: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .product-card:hover .card-img-top {
            transform: scale(1.05);
            border-bottom-color: var(--primary-color);
        }

        /* Product Image in Table */
        .product-image-table {
            width: 100px;
            height: 100px;
            object-fit: contain;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-image-table:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            z-index: 10;
            position: relative;
        }

        /* Product Image in Modal */
        .product-image-modal {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
        }

        /* No Image Placeholder */
        .no-image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: var(--text-secondary);
            font-size: 12px;
            text-align: center;
            border: 2px dashed var(--border-color);
        }

        .no-image-placeholder i {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Input Group */
        .input-group {
            gap: 10px;
        }

        .input-group .btn {
            border-radius: 8px;
        }

        /* Radio Button Styles */
        .form-check-input {
            background-color: var(--bg-card);
            border: 2px solid var(--border-color);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Đang xử lý...</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h2 class="page-title"><i class="fas fa-shopping-cart me-2"></i>Bán Hàng</h2>

    <div class="row">
        <!-- Bên trái: Thông tin khách hàng và tìm kiếm sản phẩm -->
        <div class="col-md-8">
            <!-- Phần chọn khách hàng -->
            <div class="card mb-3">
                    <div class="card-header bg-primary">
                        <i class="fas fa-user me-2"></i>Thông Tin Khách Hàng
                </div>
                <div class="card-body">
                    <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Khách Hàng Thân Thiết</label>
                                <select id="khachHangSelect" class="form-control form-select">
                                <option value="">-- Chọn khách hàng --</option>
                                @foreach (var kh in Model.KhachHangList)
                                {
                                    <option value="@kh.IdKhachHang" data-diem="@kh.DiemTichLuy">
                                        @kh.HoTenKhachHang - @kh.SdtKhachHang
                                    </option>
                                }
                            </select>
                            <small id="diemTichLuy" class="text-success"></small>
                        </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hoặc Khách Vãng Lai</label>
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="setKhachVangLai()">
                                    <i class="fas fa-user-slash me-2"></i>Khách Vãng Lai
                            </button>
                            <input type="hidden" id="idKhachHang" value="" />
                        </div>
                    </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tên khách hàng <span class="text-danger">*</span></label>
                                <input type="text" id="tenKhachHang" class="form-control" placeholder="Tên khách hàng" required />
                            <small id="tenKhachHangError" class="text-danger d-none"></small>
                        </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                <input type="text" id="sdtKhachHang" class="form-control" placeholder="Số điện thoại" required />
                            <small id="sdtKhachHangError" class="text-danger d-none"></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phần tìm kiếm sản phẩm -->
            <div class="card mb-3">
                    <div class="card-header bg-info">
                        <i class="fas fa-search me-2"></i>Tìm Kiếm Sản Phẩm
                </div>
                <div class="card-body">
                        <div class="input-group mb-3">
                        <input type="text" id="searchProduct" class="form-control" placeholder="Nhập tên sản phẩm để tìm kiếm..." />
                            <button class="btn btn-primary" onclick="searchProducts()">
                                <i class="fas fa-search me-1"></i>Tìm
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="resetSearch()">
                                <i class="fas fa-undo me-1"></i>Đặt lại
                            </button>
                    </div>
                    <div id="searchResults" class="mt-3">
                        <!-- Kết quả tìm kiếm sẽ hiển thị ở đây -->
                    </div>
                    <div id="modelResults" class="mt-3">
                        <!-- Danh sách model theo sản phẩm -->
                    </div>
                </div>
            </div>

            <!-- Phần sản phẩm đã chọn -->
            <div class="card">
                    <div class="card-header bg-success">
                        <i class="fas fa-shopping-cart me-2"></i>Sản Phẩm Đã Chọn
                </div>
                <div class="card-body">
                        <div class="table-responsive">
                    <table class="table table-bordered" id="selectedProductsTable">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Ảnh</th>
                                <th>Tên Model</th>
                                <th>Thuộc tính</th>
                                <th>Giá</th>
                                <th>IMEI</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="selectedProductsBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-shopping-cart me-2"></i>Chưa có sản phẩm nào được chọn
                                        </td>
                                    </tr>
                        </tbody>
                    </table>
                        </div>
                </div>
            </div>
        </div>

        <!-- Bên phải: Thanh toán -->
        <div class="col-md-4">
            <div class="card">
                    <div class="card-header bg-warning">
                        <i class="fas fa-money-bill-wave me-2"></i>Thanh Toán
                </div>
                <div class="card-body">
                    <div class="mb-3">
                            <label class="form-label">Phương Thức Thanh Toán</label>
                            <select id="phuongThucTT" class="form-control form-select">
                            <option value="Tiền mặt">Tiền mặt</option>
                            <option value="Chuyển khoản">Chuyển khoản</option>
                        </select>
                    </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="summary-label">Tổng tiền hàng</span>
                            <span id="tongTienHang" class="summary-value text-danger">0 đ</span>
                        </div>
                    </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="summary-label">Tổng thanh toán</span>
                            <span id="tongThanhToan" class="summary-value text-primary">0 đ</span>
                        </div>
                    </div>

                    <!-- Phần tiền khách đưa - chỉ hiển thị khi chọn "Tiền mặt" -->
                    <div class="mb-3" id="tienKhachDuaSection">
                            <label class="form-label">Số tiền khách đưa (VNĐ)</label>
                            <input type="number" id="tienKhachDua" class="form-control" value="0" min="0" max="10000000000" step="1000" />
                            <small class="form-text text-muted">Số tiền tối thiểu: 0 VNĐ, tối đa: 10.000.000.000 VNĐ</small>
                            <small id="tienKhachDuaError" class="text-danger d-none"></small>
                    </div>

                    <div class="mb-3" id="tienThuaSection">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="summary-label">Tiền thừa</span>
                            <span id="tienThua" class="summary-value text-info">0 đ</span>
                        </div>
                            <div id="tienThuaWarning" class="alert alert-danger mt-2 mb-0 d-none">
                                <i class="fas fa-exclamation-triangle me-1"></i>Không thanh toán - Số tiền khách đưa chưa đủ!
                        </div>
                    </div>

                        <button class="btn btn-success w-100 btn-lg" onclick="thanhToan()">
                            <i class="fas fa-check me-2"></i>THANH TOÁN
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chi tiết sản phẩm -->
<div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Chi Tiết Sản Phẩm</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- Nội dung chi tiết sản phẩm sẽ load ở đây -->
            </div>
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="addSelectedProduct()">
                        <i class="fas fa-plus me-1"></i>Thêm vào hóa đơn
                    </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal QR Code Ngân Hàng -->
<div class="modal fade" id="bankQRModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                    <h5 class="modal-title text-white"><i class="fas fa-qrcode me-2"></i>Thanh Toán Chuyển Khoản</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="bankQRContent">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="text-muted">Đang tạo mã QR...</p>
                </div>
            </div>
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="btnConfirmBankPayment" onclick="confirmBankPayment()">
                        <i class="fas fa-check-circle me-2"></i>Đã chuyển khoản - Xác nhận đơn hàng
                    </button>
            </div>
        </div>
    </div>
</div>

    <script>
        var selectedProducts = [];
        var currentProductDetail = null;
        var currentProductName = '';
        var virtualInvoicesKey = 'virtualInvoices';

        function renderPrice(value) {
            return Number(value || 0).toLocaleString() + ' đ';
        }

        // Tìm kiếm sản phẩm khi nhấn nút
        function searchProducts() {
            var keyword = $('#searchProduct').val();
            if (!keyword || !keyword.trim()) {
                $('#searchResults').empty();
                $('#modelResults').empty();
                return;
            }

            $.get('@Url.Action("SearchProducts", "DonHang")', { keyword: keyword }, function (response) {
                if (response && response.success && response.data && response.data.length > 0) {
                    var html = '<div class="list-group">';
                    response.data.forEach(function (product) {
                        var tenSanPham = product.tenSanPham || 'N/A';
                        var thuongHieu = product.thuongHieu || 'N/A';
                        html += '<button type="button" class="list-group-item list-group-item-action" onclick="selectProduct(' + product.idSanPham + ', \'' + tenSanPham.replace(/'/g, "\\'") + '\')">' +
                            '<div class="d-flex w-100 justify-content-between align-items-center">' +
                                '<span class="flex-grow-1 text-left">' + tenSanPham + '</span>' +
                                '<small class="text-muted ml-3">' + thuongHieu + '</small>' +
                            '</div>' +
                        '</button>';
                    });
                    html += '</div>';
                    $('#searchResults').html(html);
                } else {
                    $('#searchResults').html('<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Không tìm thấy sản phẩm nào</div>');
                    $('#modelResults').empty();
                }
            });
        }

        function resetSearch() {
            $('#searchProduct').val('');
            $('#searchResults').empty();
            $('#modelResults').empty();
            currentProductDetail = null;
            currentProductName = '';
        }

        function selectProduct(productId, productName) {
            currentProductName = productName || '';
            $('#modelResults').html('<div class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Đang tải model...</div>');
            $.get('@Url.Action("GetModelsByProduct", "DonHang")', { productId: productId }, function (response) {
                if (response && response.success && response.data && response.data.length > 0) {
                    var html = '<div class="row">';
                    response.data.forEach(function (model) {
                        var img = model.anh ? model.anh : '/images/no-image.png';
                        var imgHtml = img && img !== '/images/no-image.png' 
                            ? '<img class="card-img-top" src="' + img + '" alt="' + model.tenModel + '" onerror="this.src=\'/images/no-image.png\'">'
                            : '<div class="card-img-top no-image-placeholder"><div><i class="fas fa-image"></i><div>Không có ảnh</div></div></div>';
                        
                        html += '' +
                            '<div class="col-md-4 mb-3">' +
                                '<div class="card product-card h-100" style="cursor:pointer;" onclick="showModelDetail(' + model.idModelSanPham + ')">' +
                                    imgHtml +
                                    '<div class="card-body">' +
                                        '<h6 class="card-title mb-2" style="color: var(--text-primary); font-weight: 600;">' + model.tenModel + '</h6>' +
                                        '<p class="card-text mb-2" style="color: var(--text-secondary);"><i class="fas fa-palette me-1"></i><strong>Màu:</strong> ' + (model.mau || 'N/A') + '</p>' +
                                        '<p class="card-text mb-2" style="color: var(--text-secondary);"><i class="fas fa-memory me-1"></i><strong>RAM/ROM:</strong> ' + (model.ram || '-') + ' / ' + (model.rom || '-') + '</p>' +
                                        '<p class="card-text mb-2" style="color: var(--text-primary); font-size: 1.1rem;"><strong>Giá:</strong> <span class="text-success fw-bold">' + renderPrice(model.giaBanModel) + '</span></p>' +
                                        '<p class="card-text mb-0" style="color: var(--text-secondary);"><i class="fas fa-boxes me-1"></i><strong>Tồn:</strong> <span class="' + ((model.soLuongTon || 0) > 0 ? 'text-success' : 'text-danger') + '">' + (model.soLuongTon || 0) + '</span></p>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                    });
                    html += '</div>';
                    $('#modelResults').html(html);
                } else {
                    $('#modelResults').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Sản phẩm chưa có model khả dụng.</div>');
                }
            });
        }

        // Hiển thị chi tiết model + IMEI
        function showModelDetail(productId) {
            $.get('@Url.Action("GetProductDetail", "DonHang")', { id: productId }, function (response) {
                if (response && response.success) {
                    currentProductDetail = response.data;

                    var img = currentProductDetail.anh ? currentProductDetail.anh : '/images/no-image.png';
                    var hasImei = currentProductDetail.imeis && currentProductDetail.imeis.length > 0;
                    var imeiOptions = '<option value="">-- Chọn IMEI --</option>';
                    
                    if (hasImei) {
                        currentProductDetail.imeis.forEach(function (imei) {
                            imeiOptions += '<option value="' + imei.idImei + '">' + imei.maImei + '</option>';
                        });
                    } else {
                        imeiOptions = '<option value="">Không có IMEI khả dụng</option>';
                    }

                    var modalImgHtml = img && img !== '/images/no-image.png'
                        ? '<img src="' + img + '" alt="' + currentProductDetail.tenModel + '" class="product-image-modal" onerror="this.src=\'/images/no-image.png\'">'
                        : '<div class="product-image-modal no-image-placeholder" style="height: 400px;"><div><i class="fas fa-image" style="font-size: 48px;"></i><div style="margin-top: 10px; font-size: 14px;">Không có ảnh</div></div></div>';

                    var imeiSectionHtml = hasImei
                        ? '<div class="mb-3">' +
                            '<label class="form-label"><i class="fas fa-mobile-alt me-2"></i>Chọn IMEI <span class="text-danger">*</span></label>' +
                            '<select id="modalImeiSelect" class="form-control form-select">' +
                                imeiOptions +
                            '</select>' +
                          '</div>'
                        : '<div class="alert alert-danger mb-3">' +
                            '<i class="fas fa-exclamation-triangle me-2"></i><strong>Cảnh báo:</strong> Sản phẩm này chưa có IMEI khả dụng. Không thể thêm vào đơn hàng!' +
                          '</div>' +
                          '<div class="mb-3">' +
                            '<label class="form-label"><i class="fas fa-mobile-alt me-2"></i>Chọn IMEI</label>' +
                            '<select id="modalImeiSelect" class="form-control form-select" disabled>' +
                                imeiOptions +
                            '</select>' +
                          '</div>';

                    var html = '' +
                        '<div class="row">' +
                            '<div class="col-md-5 mb-3">' +
                                modalImgHtml +
                            '</div>' +
                            '<div class="col-md-7">' +
                                '<h4 class="mb-3" style="color: var(--text-primary); font-weight: 600;">' + (currentProductDetail.tenSanPham || '') + ' - ' + currentProductDetail.tenModel + '</h4>' +
                                '<div class="mb-3 p-3" style="background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid var(--primary-color);">' +
                                    '<p class="mb-2" style="color: var(--text-primary);"><i class="fas fa-tag me-2"></i><strong>Giá bán: </strong><span class="text-success fw-bold fs-5">' + renderPrice(currentProductDetail.giaBanModel) + '</span></p>' +
                                '</div>' +
                                '<p class="mb-2" style="color: var(--text-secondary);"><i class="fas fa-palette me-2"></i><strong>Màu sắc: </strong><span style="color: var(--text-primary);">' + (currentProductDetail.tenMau || 'N/A') + '</span></p>' +
                                '<p class="mb-2" style="color: var(--text-secondary);"><i class="fas fa-memory me-2"></i><strong>RAM/ROM: </strong><span style="color: var(--text-primary);">' + (currentProductDetail.ram || '-') + ' / ' + (currentProductDetail.rom || '-') + '</span></p>' +
                                '<p class="mb-3" style="color: var(--text-secondary);"><i class="fas fa-boxes me-2"></i><strong>Số lượng tồn: </strong><span class="' + ((currentProductDetail.soLuongTon || 0) > 0 ? 'text-success' : 'text-danger') + ' fw-bold">' + (currentProductDetail.soLuongTon || 0) + '</span></p>' +
                                imeiSectionHtml +
                            '</div>' +
                        '</div>';

                    $('#productDetailContent').html(html);
                    // Disable nút thêm nếu không có IMEI hoặc chưa chọn IMEI
                    var addButton = $('#productDetailModal .btn-primary');
                    if (!hasImei) {
                        addButton.prop('disabled', true).addClass('disabled').html('<i class="fas fa-ban me-1"></i>Không thể thêm (Chưa có IMEI)');
                    } else {
                        // Ban đầu disable, chỉ enable khi đã chọn IMEI
                        addButton.prop('disabled', true).addClass('disabled').html('<i class="fas fa-ban me-1"></i>Vui lòng chọn IMEI');
                    }
                    
                    var modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
                    modal.show();
                } else {
                    alert('Không tìm thấy thông tin sản phẩm');
                }
            });
        }

        // Thêm sản phẩm đã chọn vào hóa đơn
        function addSelectedProduct() {
            if (!currentProductDetail) return;

            // Kiểm tra nếu sản phẩm không có IMEI
            var hasImei = currentProductDetail.imeis && currentProductDetail.imeis.length > 0;
            if (!hasImei) {
                alert('Không thể thêm sản phẩm: Sản phẩm này chưa có IMEI khả dụng. Vui lòng kiểm tra lại!');
                return;
            }

            var selectedImei = $('#modalImeiSelect').val();
            if (!selectedImei || selectedImei === '') {
                alert('Vui lòng chọn IMEI trước khi thêm sản phẩm vào đơn hàng!');
                return;
            }

            // Kiểm tra IMEI trùng lặp
            if (selectedImei) {
                var imeiDup = selectedProducts.some(function (p) {
                    return p.selectedImeis && p.selectedImeis.indexOf(parseInt(selectedImei)) !== -1;
                });
                if (imeiDup) {
                    alert('IMEI này đã được chọn cho sản phẩm khác trong đơn hàng!');
                    return;
                }
            }

            var selectedImeiObj = null;
            if (selectedImei && currentProductDetail.imeis) {
                selectedImeiObj = currentProductDetail.imeis.find(function (i) { return i.idImei == selectedImei; });
            }

            var product = {
                idModelSanPham: currentProductDetail.idModelSanPham,
                idSanPham: currentProductDetail.idSanPham,
                tenModel: currentProductDetail.tenModel,
                tenSanPham: currentProductDetail.tenSanPham,
                giaBanModel: currentProductDetail.giaBanModel,
                tenMau: currentProductDetail.tenMau,
                soLuongTon: currentProductDetail.soLuongTon,
                soLuong: 1,
                imeis: currentProductDetail.imeis || [],
                selectedImeis: selectedImei ? [parseInt(selectedImei)] : [],
                maImei: selectedImeiObj ? selectedImeiObj.maImei : '',
                ram: currentProductDetail.ram,
                rom: currentProductDetail.rom,
                anh: currentProductDetail.anh
            };

            selectedProducts.push(product);
            renderSelectedProducts();
            var modal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
            modal.hide();
        }

        // Cập nhật IMEI khi chọn trong bảng
        $('#selectedProductsBody').on('change', '.imei-select', function () {
            var index = parseInt($(this).data('index'));
            var imeiId = $(this).val();
            var product = selectedProducts[index];
            if (!product) return;

            if (imeiId) {
                var imeiNumber = parseInt(imeiId);
                var duplicate = selectedProducts.some(function (p, idx) {
                    if (idx === index) return false;
                    return p.selectedImeis && p.selectedImeis.indexOf(imeiNumber) !== -1;
                });
                if (duplicate) {
                    alert('IMEI này đã được chọn cho sản phẩm khác.');
                    $(this).val(product.selectedImeis.length ? product.selectedImeis[0] : '');
                    return;
                }
            }

            if (!imeiId) {
                product.selectedImeis = [];
                product.maImei = '';
            } else {
                var imeiIdNumber = parseInt(imeiId);
                product.selectedImeis = [imeiIdNumber];
                var imeiObj = (product.imeis || []).find(function (i) { return i.idImei === imeiIdNumber; });
                product.maImei = imeiObj ? imeiObj.maImei : '';
            }

            renderSelectedProducts();
        });

        // Hiển thị danh sách sản phẩm đã chọn
        function renderSelectedProducts() {
            var tbody = $('#selectedProductsBody');
            tbody.empty();

            if (selectedProducts.length === 0) {
                tbody.html('<tr><td colspan="7" class="text-center text-muted"><i class="fas fa-shopping-cart me-2"></i>Chưa có sản phẩm nào được chọn</td></tr>');
                calculatePayment(0);
                return;
            }

            var total = 0;

            selectedProducts.forEach(function (product, index) {
                var rowTotal = Number(product.giaBanModel || 0) * Number(product.soLuong || 0);
                total += rowTotal;

                var imeiDisplay = product.maImei || '<span class="text-warning">Chưa chọn IMEI</span>';
                var tonDisplay = product.soLuongTon != null ? product.soLuongTon : 0;

                var productImg = product.anh || '/images/no-image.png';
                var imgCellHtml;
                if (productImg && productImg !== '/images/no-image.png') {
                    imgCellHtml = '<img src="' + productImg + '" alt="' + product.tenModel + '" class="product-image-table" onerror="this.onerror=null; this.src=\'/images/no-image.png\'; this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                        '<div class="product-image-table no-image-placeholder" style="display:none;"><i class="fas fa-image"></i></div>';
                } else {
                    imgCellHtml = '<div class="product-image-table no-image-placeholder"><i class="fas fa-image"></i></div>';
                }
                
                var row = '' +
                    '<tr id="selected_' + index + '" style="transition: background-color 0.2s;">' +
                        '<td class="align-middle"><strong>' + (index + 1) + '</strong></td>' +
                        '<td class="align-middle">' + imgCellHtml + '</td>' +
                        '<td class="align-middle">' +
                            '<div style="font-weight: 500; color: var(--text-primary); margin-bottom: 5px;">' + (product.tenSanPham || '') + '</div>' +
                            '<div style="color: var(--text-secondary); font-size: 0.9rem;">' + product.tenModel + '</div>' +
                        '</td>' +
                        '<td class="align-middle" style="font-size: 0.9rem;">' +
                            '<div class="mb-1"><i class="fas fa-palette me-1 text-secondary"></i><strong>Màu: </strong><span style="color: var(--text-primary);">' + (product.tenMau || 'N/A') + '</span></div>' +
                            '<div class="mb-1"><i class="fas fa-memory me-1 text-secondary"></i><strong>RAM/ROM: </strong><span style="color: var(--text-primary);">' + (product.ram || '-') + ' / ' + (product.rom || '-') + '</span></div>' +
                            '<div><i class="fas fa-boxes me-1 text-secondary"></i><strong>Tồn: </strong><span class="' + (tonDisplay > 0 ? 'text-success' : 'text-danger') + '">' + tonDisplay + '</span></div>' +
                        '</td>' +
                        '<td class="align-middle"><span class="text-success fw-bold" style="font-size: 1.1rem;">' + renderPrice(product.giaBanModel) + '</span></td>' +
                        '<td class="align-middle">' + imeiDisplay + '</td>' +
                        '<td class="align-middle">' +
                            '<button class="btn btn-danger btn-sm" onclick="removeSelectedProduct(' + index + ')" title="Xóa sản phẩm" style="min-width: 40px;">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</td>' +
                    '</tr>';
                tbody.append(row);
            });

            calculatePayment(total);
        }

        function removeSelectedProduct(index) {
            selectedProducts.splice(index, 1);
            renderSelectedProducts();
        }

        function calculatePayment(total) {
            var thanhToan = total;
            var tienKhachDua = parseFloat($('#tienKhachDua').val()) || 0;
            var tienThua = tienKhachDua - thanhToan;

            $('#tongTienHang').text(renderPrice(total));
            $('#tongThanhToan').text(renderPrice(thanhToan));
            
            if (tienThua >= 0) {
                $('#tienThua').text(renderPrice(tienThua)).removeClass('text-danger').addClass('text-info');
                $('#tienThuaWarning').addClass('d-none');
            } else {
                $('#tienThua').text(renderPrice(Math.abs(tienThua)) + ' (thiếu)').removeClass('text-info').addClass('text-danger');
                $('#tienThuaWarning').removeClass('d-none');
            }
        }

        function setKhachVangLai() {
            $('#khachHangSelect').val('');
            $('#idKhachHang').val('');
            $('#diemTichLuy').text('');
            $('#tenKhachHang').val('').prop('disabled', false);
            $('#sdtKhachHang').val('').prop('disabled', false);
            $('#tenKhachHangError').addClass('d-none').text('');
            $('#sdtKhachHangError').addClass('d-none').text('');
        }

        function validateKhachHang() {
            var isValid = true;
            var tenKhachHang = $('#tenKhachHang').val().trim();
            var sdtKhachHang = $('#sdtKhachHang').val().trim();
            var idKhachHang = $('#idKhachHang').val();

            if (idKhachHang && idKhachHang !== '') {
                $('#tenKhachHangError').addClass('d-none').text('');
                $('#sdtKhachHangError').addClass('d-none').text('');
                return true;
            }

            if (!tenKhachHang || tenKhachHang.length === 0) {
                $('#tenKhachHangError').removeClass('d-none').text('Vui lòng nhập tên khách hàng');
                isValid = false;
            } else if (tenKhachHang.length < 2) {
                $('#tenKhachHangError').removeClass('d-none').text('Tên khách hàng phải có ít nhất 2 ký tự');
                isValid = false;
            } else if (tenKhachHang.length > 100) {
                $('#tenKhachHangError').removeClass('d-none').text('Tên khách hàng không được vượt quá 100 ký tự');
                isValid = false;
            } else {
                $('#tenKhachHangError').addClass('d-none').text('');
            }

            var phoneRegex = /^(0|\+84)[0-9]{9,10}$/;
            if (!sdtKhachHang || sdtKhachHang.length === 0) {
                $('#sdtKhachHangError').removeClass('d-none').text('Vui lòng nhập số điện thoại');
                isValid = false;
            } else if (!phoneRegex.test(sdtKhachHang.replace(/\s/g, ''))) {
                $('#sdtKhachHangError').removeClass('d-none').text('Số điện thoại không hợp lệ (VD: 0123456789 hoặc +84123456789)');
                isValid = false;
            } else {
                $('#sdtKhachHangError').addClass('d-none').text('');
            }

            return isValid;
        }

        function showLoading() {
            $('#loadingOverlay').css('display', 'flex');
        }

        function hideLoading() {
            $('#loadingOverlay').css('display', 'none');
        }

        function cleanForm() {
            // Xóa sản phẩm đã chọn
            selectedProducts = [];
            renderSelectedProducts();
            
            // Reset form khách hàng
            $('#khachHangSelect').val('');
            $('#idKhachHang').val('');
            $('#diemTichLuy').text('');
            $('#tenKhachHang').val('').prop('disabled', false);
            $('#sdtKhachHang').val('').prop('disabled', false);
            $('#tenKhachHangError').addClass('d-none').text('');
            $('#sdtKhachHangError').addClass('d-none').text('');
            
            // Reset thanh toán
            $('#tienKhachDua').val(0);
            $('#phuongThucTT').val('Tiền mặt');
            
            // Reset tìm kiếm
            resetSearch();
        }

        function thanhToan() {
            // Validation: Kiểm tra có sản phẩm không
            if (selectedProducts.length === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm');
                return;
            }

            // Validation: Kiểm tra IMEI cho tất cả sản phẩm
            var hasMissingImei = selectedProducts.some(function (p) { return !p.selectedImeis || p.selectedImeis.length === 0; });
            if (hasMissingImei) {
                alert('Vui lòng chọn IMEI cho tất cả sản phẩm trước khi thanh toán');
                return;
            }

            // Validation: Kiểm tra thông tin khách hàng
            if (!validateKhachHang()) {
                alert('Vui lòng kiểm tra lại thông tin khách hàng');
                return;
            }

            // Validation: Kiểm tra phương thức thanh toán
            var phuongThucTT = $('#phuongThucTT').val();
            if (!phuongThucTT || phuongThucTT === '') {
                alert('Vui lòng chọn phương thức thanh toán');
                return;
            }

            // Validation: Kiểm tra số tiền
            var tongThanhToan = parseFloat($('#tongThanhToan').text().replace(/[^0-9]/g, '')) || 0;
            if (tongThanhToan <= 0) {
                alert('Tổng tiền thanh toán phải lớn hơn 0');
                return;
            }

            // Nếu chọn "Chuyển khoản", tạo dữ liệu đơn hàng và hiển thị modal QR code
            if (phuongThucTT === 'Chuyển khoản') {
                // Tạo dữ liệu đơn hàng trước
                pendingOrderData = {
                    IdKhachHang: $('#khachHangSelect').val() || null,
                    TenKhachHang: $('#tenKhachHang').val().trim() || '',
                    SdtKhachHang: $('#sdtKhachHang').val().trim() || '',
                    DiaChiGiaoHang: 'Thanh Toán Tại Quầy',
                    PhuongThucThanhToan: phuongThucTT,
                    TienKhachDua: null,
                    TienThua: null,
                    ChiTietDonHang: selectedProducts.map(function (p) {
                        return {
                            IdModelSanPham: p.idModelSanPham,
                            SoLuong: p.soLuong,
                            SelectedImeis: p.selectedImeis,
                            IdKhuyenMai: p.idKhuyenMai || null
                        };
                    })
                };
                // Hiển thị modal QR code
                showBankQRModal(tongThanhToan);
                return;
            }

            // Validation: Nếu thanh toán bằng tiền mặt, phải nhập số tiền khách đưa
            if (phuongThucTT === 'Tiền mặt') {
                var tienKhachDua = parseFloat($('#tienKhachDua').val()) || 0;
                var minTien = 0;
                var maxTien = 10000000000; // 10 tỷ VNĐ
                
                // Validate số tiền khách đưa
                if (tienKhachDua <= 0) {
                    $('#tienKhachDuaError').removeClass('d-none').text('Vui lòng nhập số tiền khách đưa (phải lớn hơn 0)');
                    $('#tienKhachDua').focus();
                    return;
                }
                
                if (tienKhachDua < minTien) {
                    $('#tienKhachDuaError').removeClass('d-none').text('Số tiền khách đưa không được nhỏ hơn ' + minTien.toLocaleString() + ' VNĐ');
                    $('#tienKhachDua').focus();
                    return;
                }
                
                if (tienKhachDua > maxTien) {
                    $('#tienKhachDuaError').removeClass('d-none').text('Số tiền khách đưa không được vượt quá ' + maxTien.toLocaleString() + ' VNĐ (10 tỷ VNĐ)');
                    $('#tienKhachDua').focus();
                    return;
                }
                
                $('#tienKhachDuaError').addClass('d-none').text('');
                
                var tienThua = tienKhachDua - tongThanhToan;
                if (tienThua < 0) {
                    alert('Không thanh toán - Số tiền khách đưa chưa đủ! Còn thiếu: ' + Math.abs(tienThua).toLocaleString() + ' đ');
                    $('#tienKhachDua').focus();
                    return;
                }
            }

            // Hiển thị loading
            showLoading();

            // Tạo dữ liệu đơn hàng và submit
            submitOrderData(phuongThucTT, tongThanhToan);
        }

        function submitOrderData(phuongThucTT, tongThanhToan) {
            var tienKhachDua = parseFloat($('#tienKhachDua').val()) || 0;
            var tienThua = tienKhachDua - tongThanhToan;

            var orderData = {
                IdKhachHang: $('#khachHangSelect').val() || null,
                TenKhachHang: $('#tenKhachHang').val().trim() || '',
                SdtKhachHang: $('#sdtKhachHang').val().trim() || '',
                DiaChiGiaoHang: 'Thanh Toán Tại Quầy',
                PhuongThucThanhToan: phuongThucTT,
                TienKhachDua: phuongThucTT === 'Tiền mặt' ? tienKhachDua : null,
                TienThua: phuongThucTT === 'Tiền mặt' ? tienThua : null,
                ChiTietDonHang: selectedProducts.map(function (p) {
                    return {
                        IdModelSanPham: p.idModelSanPham,
                        SoLuong: p.soLuong,
                        SelectedImeis: p.selectedImeis,
                        IdKhuyenMai: p.idKhuyenMai || null
                    };
                })
            };

            // Lưu dữ liệu đơn hàng để dùng khi xác nhận chuyển khoản (nếu là chuyển khoản)
            if (phuongThucTT === 'Chuyển khoản') {
                pendingOrderData = orderData;
                // Không submit ngay, đợi user xác nhận trong modal
                return;
            }

            $.post('@Url.Action("Create", "DonHang")', orderData, function (response) {
                hideLoading();
                
                if (response && response.success) {
                    var message = 'Thanh toán thành công!\nMã đơn: ' + response.maDon + '\nNgày bảo hành: ' + response.ngayBaoHanh;
                    alert(message);
                    
                    // Clean form sau khi thanh toán thành công
                    cleanForm();
                    
                    // Tự động tải PDF xuống
                    if (response.maDon) {
                        // Tạo URL để download PDF
                        var pdfDownloadUrl = '/DonHang/ExportPdf?maDon=' + encodeURIComponent(response.maDon);
                        
                        // Sử dụng fetch để tải PDF và trigger download
                        fetch(pdfDownloadUrl)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Không thể tải PDF');
                                }
                                return response.blob();
                            })
                            .then(blob => {
                                // Tạo URL từ blob
                                var url = window.URL.createObjectURL(blob);
                                
                                // Tạo link ẩn để trigger download
                                var link = document.createElement('a');
                                link.href = url;
                                link.download = 'HoaDon_' + response.maDon + '.pdf';
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                
                                // Cleanup
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(url);
                            })
                            .catch(error => {
                                console.error('Lỗi khi tải PDF:', error);
                                // Fallback: mở trong tab mới nếu fetch thất bại
                                window.open(pdfDownloadUrl, '_blank');
                            });
                    }
                } else {
                    var errorMsg = 'Lỗi: ' + (response ? (response.message || 'Không xác định') : 'Không xác định');
                    if (response && response.errors && Array.isArray(response.errors)) {
                        errorMsg += '\n' + response.errors.join('\n');
                    }
                    alert(errorMsg);
                }
            }).fail(function(xhr, status, error) {
                hideLoading();
                console.error('Lỗi AJAX:', error);
                var errorMsg = 'Có lỗi xảy ra khi thanh toán. Vui lòng thử lại.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert(errorMsg);
            });
        }

        // Hiển thị modal QR code ngân hàng
        function showBankQRModal(tongTien) {
            // Hiển thị loading
            $('#bankQRContent').html(
                '<div class="spinner-border text-primary mb-3" role="status">' +
                '<span class="visually-hidden">Đang tải...</span>' +
                '</div>' +
                '<p class="text-muted">Đang tạo mã QR...</p>'
            );

            // Mở modal
            var modal = new bootstrap.Modal(document.getElementById('bankQRModal'));
            modal.show();

            // Gọi API để lấy thông tin QR code
            $.get('@Url.Action("GetBankQRCode", "DonHang")', {
                tongTien: tongTien,
                noiDung: 'THANH TOAN DON HANG ' + new Date().toISOString().slice(0, 10).replace(/-/g, '')
            }, function (response) {
                if (response && response.success) {
                    var html = '' +
                        '<div class="mb-4">' +
                        '<h5 class="mb-3" style="color: var(--text-primary);">Thông Tin Chuyển Khoản</h5>' +
                        '<div class="card mb-3" style="background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary-color);">' +
                        '<div class="card-body text-start">' +
                        '<p class="mb-2"><strong>Ngân hàng:</strong> <span style="color: var(--primary-color);">' + response.bankName + '</span></p>' +
                        '<p class="mb-2"><strong>Số tài khoản:</strong> <span style="color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">' + response.accountNumber + '</span></p>' +
                        '<p class="mb-2"><strong>Chủ tài khoản:</strong> <span style="color: var(--text-primary);">' + response.accountName + '</span></p>' +
                        '<p class="mb-0"><strong>Số tiền:</strong> <span class="text-success fw-bold" style="font-size: 1.2rem;">' + renderPrice(response.tongTien) + '</span></p>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div class="mb-4">' +
                        '<h5 class="mb-3" style="color: var(--text-primary);">Mã QR Code</h5>' +
                        '<div class="d-flex justify-content-center">' +
                        '<img src="' + response.qrCodeUrl + '" alt="QR Code" style="max-width: 300px; border: 2px solid var(--border-color); border-radius: 8px; padding: 10px; background: white;">' +
                        '</div>' +
                        '<p class="text-muted mt-3" style="font-size: 0.9rem;">Quét mã QR bằng ứng dụng ngân hàng để thanh toán</p>' +
                        '</div>' +
                        '<div class="alert alert-info">' +
                        '<i class="fas fa-info-circle me-2"></i><strong>Hướng dẫn:</strong> Sau khi chuyển khoản thành công, vui lòng nhấn nút "Đã chuyển khoản" để xác nhận đơn hàng.' +
                        '</div>';

                    $('#bankQRContent').html(html);
                } else {
                    $('#bankQRContent').html(
                        '<div class="alert alert-danger">' +
                        '<i class="fas fa-exclamation-triangle me-2"></i>Lỗi: ' + (response.message || 'Không thể tạo QR code') +
                        '</div>'
                    );
                }
            }).fail(function () {
                $('#bankQRContent').html(
                    '<div class="alert alert-danger">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>Lỗi kết nối. Vui lòng thử lại.' +
                    '</div>'
                );
            });
        }

        // Xác nhận đã chuyển khoản và tạo đơn hàng
        function confirmBankPayment() {
            if (!pendingOrderData) {
                alert('Không có dữ liệu đơn hàng. Vui lòng thử lại.');
                return;
            }

            // Đóng modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('bankQRModal'));
            modal.hide();

            // Hiển thị loading
            showLoading();

            // Submit đơn hàng
            $.post('@Url.Action("Create", "DonHang")', pendingOrderData, function (response) {
                hideLoading();

                if (response && response.success) {
                    var message = 'Đơn hàng đã được tạo thành công!\nMã đơn: ' + response.maDon + '\nTrạng thái: Chờ xác nhận thanh toán\n\nVui lòng đợi xác nhận từ hệ thống sau khi chuyển khoản.';
                    alert(message);

                    // Clean form sau khi tạo đơn hàng thành công
                    cleanForm();
                    pendingOrderData = null;

                    // Tự động tải PDF xuống
                    if (response.maDon) {
                        var pdfDownloadUrl = '/DonHang/ExportPdf?maDon=' + encodeURIComponent(response.maDon);
                        fetch(pdfDownloadUrl)
                            .then(response => {
                                if (!response.ok) throw new Error('Không thể tải PDF');
                                return response.blob();
                            })
                            .then(blob => {
                                var url = window.URL.createObjectURL(blob);
                                var link = document.createElement('a');
                                link.href = url;
                                link.download = 'HoaDon_' + response.maDon + '.pdf';
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(url);
                            })
                            .catch(error => {
                                console.error('Lỗi khi tải PDF:', error);
                                window.open(pdfDownloadUrl, '_blank');
                            });
                    }
                } else {
                    var errorMsg = 'Lỗi: ' + (response ? (response.message || 'Không xác định') : 'Không xác định');
                    if (response && response.errors && Array.isArray(response.errors)) {
                        errorMsg += '\n' + response.errors.join('\n');
                    }
                    alert(errorMsg);
                }
            }).fail(function(xhr, status, error) {
                hideLoading();
                console.error('Lỗi AJAX:', error);
                var errorMsg = 'Có lỗi xảy ra khi tạo đơn hàng. Vui lòng thử lại.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert(errorMsg);
            });
        }

        $(document).ready(function () {
            // Ẩn/hiện phần tiền khách đưa khi thay đổi phương thức thanh toán
            $('#phuongThucTT').on('change', function() {
                var phuongThuc = $(this).val();
                if (phuongThuc === 'Tiền mặt') {
                    $('#tienKhachDuaSection').show();
                    $('#tienThuaSection').show();
                } else if (phuongThuc === 'Chuyển khoản') {
                    $('#tienKhachDuaSection').hide();
                    $('#tienThuaSection').hide();
                    $('#tienKhachDua').val(0);
                    $('#tienThua').text('0 đ');
                    $('#tienThuaWarning').addClass('d-none');
                }
            });

            // Trigger change để set initial state
            $('#phuongThucTT').trigger('change');
            $('#tienKhachDua').on('input', function() {
                var tienKhachDua = parseFloat($(this).val()) || 0;
                var minTien = 0;
                var maxTien = 10000000000; // 10 tỷ VNĐ
                
                // Clear error khi người dùng nhập
                $('#tienKhachDuaError').addClass('d-none').text('');
                
                // Validate min/max
                if (tienKhachDua < minTien) {
                    $('#tienKhachDuaError').removeClass('d-none').text('Số tiền không được nhỏ hơn ' + minTien.toLocaleString() + ' VNĐ');
                    return;
                }
                
                if (tienKhachDua > maxTien) {
                    $('#tienKhachDuaError').removeClass('d-none').text('Số tiền không được vượt quá ' + maxTien.toLocaleString() + ' VNĐ (10 tỷ VNĐ)');
                    // Giới hạn giá trị input
                    $(this).val(maxTien);
                    tienKhachDua = maxTien;
                }
                
                var tongThanhToan = parseFloat($('#tongThanhToan').text().replace(/[^0-9]/g, '')) || 0;
                var tienThua = tienKhachDua - tongThanhToan;
                
                if (tienThua >= 0) {
                    $('#tienThua').text(renderPrice(tienThua)).removeClass('text-danger').addClass('text-info');
                    $('#tienThuaWarning').addClass('d-none');
                } else {
                    $('#tienThua').text(renderPrice(Math.abs(tienThua)) + ' (thiếu)').removeClass('text-info').addClass('text-danger');
                    $('#tienThuaWarning').removeClass('d-none');
                }
            });

            $('#khachHangSelect').on('change', function () {
                var diem = $(this).find('option:selected').data('diem');
                $('#diemTichLuy').text('Điểm: ' + (diem || 0));
                $('#idKhachHang').val($(this).val());
                var selectedText = $(this).find('option:selected').text() || '';
                var parts = selectedText.split(' - ');
                $('#tenKhachHang').val(parts[0] || '').prop('disabled', !!$(this).val());
                $('#sdtKhachHang').val(parts[1] || '').prop('disabled', !!$(this).val());
                $('#tenKhachHangError').addClass('d-none').text('');
                $('#sdtKhachHangError').addClass('d-none').text('');
            });

            $('#tenKhachHang').on('blur', function() {
                if (!$(this).prop('disabled')) {
                    validateKhachHang();
                }
            });

            $('#sdtKhachHang').on('blur', function() {
                if (!$(this).prop('disabled')) {
                    validateKhachHang();
                }
            });

            $('#sdtKhachHang').on('input', function() {
                var value = $(this).val().replace(/\s/g, '');
                if (value !== $(this).val()) {
                    $(this).val(value);
                }
            });

            // Ẩn/hiện phần tiền khách đưa khi thay đổi phương thức thanh toán
            $('#phuongThucTT').on('change', function() {
                var phuongThuc = $(this).val();
                if (phuongThuc === 'Tiền mặt') {
                    $('#tienKhachDuaSection').show();
                    $('#tienThuaSection').show();
                } else if (phuongThuc === 'Chuyển khoản') {
                    $('#tienKhachDuaSection').hide();
                    $('#tienThuaSection').hide();
                    $('#tienKhachDua').val(0);
                    $('#tienThua').text('0 đ');
                    $('#tienThuaWarning').addClass('d-none');
                }
            });

            // Trigger change để set initial state
            $('#phuongThucTT').trigger('change');

            $('#searchProduct').keypress(function (e) {
                if (e.which === 13) {
                    searchProducts();
                }
            });

            // Event handler cho việc chọn IMEI trong modal
            $(document).on('change', '#modalImeiSelect', function() {
                var selectedImei = $(this).val();
                var addButton = $('#productDetailModal .btn-primary');
                
                if (selectedImei && selectedImei !== '') {
                    addButton.prop('disabled', false).removeClass('disabled').html('<i class="fas fa-plus me-1"></i>Thêm vào hóa đơn');
                } else {
                    addButton.prop('disabled', true).addClass('disabled').html('<i class="fas fa-ban me-1"></i>Vui lòng chọn IMEI');
                }
            });
            });

        // Hiển thị modal QR code ngân hàng
        function showBankQRModal(tongTien) {
            // Hiển thị loading
            $('#bankQRContent').html(
                '<div class="spinner-border text-primary mb-3" role="status">' +
                '<span class="visually-hidden">Đang tải...</span>' +
                '</div>' +
                '<p class="text-muted">Đang tạo mã QR...</p>'
            );

            // Mở modal
            var modal = new bootstrap.Modal(document.getElementById('bankQRModal'));
            modal.show();

            // Gọi API để lấy thông tin QR code
            $.get('@Url.Action("GetBankQRCode", "DonHang")', {
                tongTien: tongTien,
                noiDung: 'THANH TOAN DON HANG ' + new Date().toISOString().slice(0, 10).replace(/-/g, '')
            }, function (response) {
                if (response && response.success) {
                    var html = '' +
                        '<div class="mb-4">' +
                        '<h5 class="mb-3" style="color: var(--text-primary);">Thông Tin Chuyển Khoản</h5>' +
                        '<div class="card mb-3" style="background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary-color);">' +
                        '<div class="card-body text-start">' +
                        '<p class="mb-2"><strong>Ngân hàng:</strong> <span style="color: var(--primary-color);">' + response.bankName + '</span></p>' +
                        '<p class="mb-2"><strong>Số tài khoản:</strong> <span style="color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">' + response.accountNumber + '</span></p>' +
                        '<p class="mb-2"><strong>Chủ tài khoản:</strong> <span style="color: var(--text-primary);">' + response.accountName + '</span></p>' +
                        '<p class="mb-0"><strong>Số tiền:</strong> <span class="text-success fw-bold" style="font-size: 1.2rem;">' + renderPrice(response.tongTien) + '</span></p>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div class="mb-4">' +
                        '<h5 class="mb-3" style="color: var(--text-primary);">Mã QR Code</h5>' +
                        '<div class="d-flex justify-content-center">' +
                        '<img src="' + response.qrCodeUrl + '" alt="QR Code" style="max-width: 300px; border: 2px solid var(--border-color); border-radius: 8px; padding: 10px; background: white;">' +
                        '</div>' +
                        '<p class="text-muted mt-3" style="font-size: 0.9rem;">Quét mã QR bằng ứng dụng ngân hàng để thanh toán</p>' +
                        '</div>' +
                        '<div class="alert alert-info">' +
                        '<i class="fas fa-info-circle me-2"></i><strong>Hướng dẫn:</strong> Sau khi chuyển khoản thành công, vui lòng nhấn nút "Đã chuyển khoản" để xác nhận đơn hàng.' +
                        '</div>';

                    $('#bankQRContent').html(html);
                } else {
                    $('#bankQRContent').html(
                        '<div class="alert alert-danger">' +
                        '<i class="fas fa-exclamation-triangle me-2"></i>Lỗi: ' + (response.message || 'Không thể tạo QR code') +
                        '</div>'
                    );
                }
            }).fail(function () {
                $('#bankQRContent').html(
                    '<div class="alert alert-danger">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>Lỗi kết nối. Vui lòng thử lại.' +
                    '</div>'
                );
            });
        }

        // Xác nhận đã chuyển khoản và tạo đơn hàng
        function confirmBankPayment() {
            if (!pendingOrderData) {
                alert('Không có dữ liệu đơn hàng. Vui lòng thử lại.');
                return;
            }

            // Đóng modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('bankQRModal'));
            modal.hide();

            // Hiển thị loading
            showLoading();

            // Submit đơn hàng
            $.post('@Url.Action("Create", "DonHang")', pendingOrderData, function (response) {
                hideLoading();

                if (response && response.success) {
                    var message = 'Đơn hàng đã được tạo thành công!\nMã đơn: ' + response.maDon + '\nTrạng thái: Chờ xác nhận thanh toán\n\nVui lòng đợi xác nhận từ hệ thống sau khi chuyển khoản.';
                    alert(message);

                    // Clean form sau khi tạo đơn hàng thành công
                    cleanForm();
                    pendingOrderData = null;

                    // Tự động tải PDF xuống
                    if (response.maDon) {
                        var pdfDownloadUrl = '/DonHang/ExportPdf?maDon=' + encodeURIComponent(response.maDon);
                        fetch(pdfDownloadUrl)
                            .then(response => {
                                if (!response.ok) throw new Error('Không thể tải PDF');
                                return response.blob();
                            })
                            .then(blob => {
                                var url = window.URL.createObjectURL(blob);
                                var link = document.createElement('a');
                                link.href = url;
                                link.download = 'HoaDon_' + response.maDon + '.pdf';
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(url);
                            })
                            .catch(error => {
                                console.error('Lỗi khi tải PDF:', error);
                                window.open(pdfDownloadUrl, '_blank');
                            });
                    }
                } else {
                    var errorMsg = 'Lỗi: ' + (response ? (response.message || 'Không xác định') : 'Không xác định');
                    if (response && response.errors && Array.isArray(response.errors)) {
                        errorMsg += '\n' + response.errors.join('\n');
                    }
                    alert(errorMsg);
                }
            }).fail(function(xhr, status, error) {
                hideLoading();
                console.error('Lỗi AJAX:', error);
                var errorMsg = 'Có lỗi xảy ra khi tạo đơn hàng. Vui lòng thử lại.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert(errorMsg);
            });
        }

        window.searchProducts = searchProducts;
        window.showModelDetail = showModelDetail;
        window.addSelectedProduct = addSelectedProduct;
        window.removeSelectedProduct = removeSelectedProduct;
        window.selectProduct = selectProduct;
    </script>
</body>
</html>
