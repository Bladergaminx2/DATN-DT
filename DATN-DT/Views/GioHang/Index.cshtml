@model IEnumerable<DATN_DT.Models.GioHang>

@{
    ViewData["Title"] = "Quản lý Giỏ Hàng";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Quản lý Giỏ Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        /* CSS Chung */
        body {
            background-color: #12121d;
            color: white;
            font-family: 'Segoe UI', sans-serif;
        }

        /* ... (Các style chung khác giữ nguyên) ... */
        .container {
            margin-top: 50px;
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #f5f5f5;
        }

        .card {
            background-color: #1e1e2a;
            border: 1px solid #333;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background-color: #2b2b33;
            color: #fff;
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .card-body {
            padding: 20px;
        }

        .table {
            color: #ddd;
        }

            .table th {
                background-color: #3e3e4a;
                color: #ccc;
            }

        .total-amount {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffc107;
        }

        .status-active {
            color: #28a745;
            font-weight: bold;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }

        .text-danger {
            color: #ff4d4d !important;
        }

        .btn-create {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            transition: 0.3s;
        }

        /* Style Modal & Form (Lấy từ IMEI CSS) */
        .modal-content {
            background-color: #2b2b33;
            color: white;
            border-radius: 10px;
        }

        /* FIX LỖI TEXT VÀ PLACEHOLDER */
        .form-control, .form-select {
            background-color: #1e1e2a;
            color: white; /* Đảm bảo chữ nhập vào màu trắng */
            border: 1px solid #444;
        }

            .form-control::placeholder { /* FIX placeholder */
                color: #aaa;
                opacity: 1;
            }

            .form-control:focus, .form-select:focus {
                border-color: #4a90e2;
                box-shadow: none;
            }

            .form-control option {
                background-color: #1e1e2a;
                color: white;
            }
    </style>
</head>
<body>
    <div class="container">
        <h2>Quản Lý Giỏ Hàng Khách Hàng</h2>

        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-create" data-bs-toggle="modal" data-bs-target="#addItemModal">
                + Thêm Sản Phẩm vào Giỏ
            </button>
        </div>

        @if (!Model.Any())
        {
            <div class="alert alert-info text-center">
                Hiện chưa có giỏ hàng nào được tạo.
            </div>
        }

        @foreach (var gioHang in Model)
        {
            var totalAmount = gioHang.GioHangChiTiets?.Sum(ghct => ghct.ThanhTien) ?? 0;
            var statusClass = gioHang.TrangThaiGio == "Hoạt động" ? "status-active" : "status-inactive";

            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between w-100">
                        <strong>ID Giỏ Hàng: @gioHang.IdGioHang</strong>
                        <span>Khách Hàng: @gioHang.KhachHang?.HoTenKhachHang</span>
                    </div>
                    <div>
                        Ngày Tạo/Cập Nhật: @gioHang.NgayTaoGio?.ToString("dd/MM/yyyy HH:mm")
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            **Trạng thái:** <span class="@statusClass">@gioHang.TrangThaiGio</span>
                        </div>
                        <div class="col-md-6 text-end">
                            **Tổng tiền Giỏ:** <span class="total-amount">@totalAmount.ToString("N0") ₫</span>
                        </div>
                    </div>

                    <h5>Sản Phẩm trong Giỏ (@gioHang.GioHangChiTiets?.Count() mục)</h5>

                    @if (gioHang.GioHangChiTiets != null && gioHang.GioHangChiTiets.Any())
                    {
                        <table class="table table-sm text-center">
                            <thead>
                                <tr><th>Model Sản Phẩm</th><th>Đơn Giá</th><th>Số Lượng</th><th>Thành Tiền</th><th></th></tr>
                            </thead>
                            <tbody>
                                @foreach (var chiTiet in gioHang.GioHangChiTiets)
                                {
                                    <tr>
                                        <td class="text-start">@chiTiet.ModelSanPham?.TenModel</td>
                                        <td>@chiTiet.DonGia?.ToString("N0") ₫</td>
                                        <td>@chiTiet.SoLuong</td>
                                        <td class="text-warning">@chiTiet.ThanhTien?.ToString("N0") ₫</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger btn-remove-item"
                                                    data-id="@chiTiet.IdGioHangChiTiet"
                                                    title="Xóa sản phẩm này khỏi giỏ">
                                                Xóa
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted">Giỏ hàng này trống.</p>
                    }

                    <div class="text-end mt-3">
                        <button class="btn btn-sm btn-danger">Chuyển thành Đơn Hàng</button>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content p-3">
                <div class="modal-header"><h5 class="modal-title">Thêm Sản Phẩm vào Giỏ Hàng</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <form id="addItemForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Khách Hàng <span class="text-danger">*</span></label>
                            <select id="AddItem_IdKhachHang" class="form-control form-select">
                                <option value="">Chọn khách hàng</option> {{-- Placeholder rõ ràng --}}
                            </select>
                            <small id="errorAddItem_IdKhachHang" class="text-danger d-none"></small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Model Sản Phẩm <span class="text-danger">*</span></label>
                            <select id="AddItem_IdModelSanPham" class="form-control form-select">
                                <option value="">Chọn model sản phẩm</option> {{-- Placeholder rõ ràng --}}
                            </select>
                            <small id="errorAddItem_IdModelSanPham" class="text-danger d-none"></small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số Lượng <span class="text-danger">*</span></label>
                            <input type="number" id="AddItem_SoLuong" class="form-control" value="1" min="1" placeholder="Nhập số lượng" />
                            <small id="errorAddItem_SoLuong" class="text-danger d-none"></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Thêm vào Giỏ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.remove("d-none");
        }

        async function loadDropdownData() {
            try {
                // Khách Hàng (từ GioHangController)
                const khachHangsResponse = await fetch('/GioHang/GetKhachHangs');
                const khachHangs = await khachHangsResponse.json();
                populateSelect('AddItem_IdKhachHang', khachHangs, 'idKhachHang', 'displayText', 'Chọn khách hàng');

                // Model Sản Phẩm (từ GioHangController)
                const modelsResponse = await fetch('/GioHang/GetModelSanPhams');
                const models = await modelsResponse.json();
                populateSelect('AddItem_IdModelSanPham', models, 'idModelSanPham', 'displayText', 'Chọn model sản phẩm');
            } catch (error) {
                console.error('Lỗi khi load dữ liệu dropdown:', error);
            }
        }

        function populateSelect(selectId, data, valueField, textField, defaultText) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="">${defaultText}</option>`; // Đặt placeholder rõ ràng
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = item[textField];
                select.appendChild(option);
            });
        }

        // --- Thêm Sản Phẩm vào Giỏ (Gọi GioHangController/AddItem) ---
        document.getElementById("addItemForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const item = {
                IdKhachHang: parseInt(AddItem_IdKhachHang.value) || 0,
                IdModelSanPham: parseInt(AddItem_IdModelSanPham.value) || 0,
                SoLuong: parseInt(AddItem_SoLuong.value) || 0
            };

            // Validation
            let isValid = true;
            document.querySelectorAll("#addItemForm small").forEach(e => e.classList.add("d-none"));
            if (item.IdKhachHang === 0) { showError("errorAddItem_IdKhachHang", "Phải chọn khách hàng!"); isValid = false; }
            if (item.IdModelSanPham === 0) { showError("errorAddItem_IdModelSanPham", "Phải chọn sản phẩm!"); isValid = false; }
            if (item.SoLuong <= 0) { showError("errorAddItem_SoLuong", "Số lượng phải > 0!"); isValid = false; }
            if (!isValid) return;

            // Gọi API
            const response = await fetch('/GioHang/AddItem', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item)
            });

            let data = {};
            try { data = await response.json(); } catch { }

            if (!response.ok) {
                alert(data.message || "Không thể cập nhật giỏ hàng. Vui lòng thử lại!");
                return;
            }

            alert(data.message || "Đã thêm sản phẩm thành công!");
            location.reload();
        });

        // --- Xóa sản phẩm khỏi giỏ hàng (Chi Tiết) ---
        async function removeItem(idGioHangChiTiet) {
            if (!confirm("Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng không?")) {
                return;
            }

            const response = await fetch(`/GioHang/RemoveItem/${idGioHangChiTiet}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            let data = {};
            try { data = await response.json(); } catch { }

            if (response.ok) {
                alert(data.message || "Đã xóa sản phẩm thành công!");
                location.reload();
            } else {
                alert(data.message || "Lỗi khi xóa sản phẩm khỏi giỏ hàng.");
            }
        }

        // --- Khởi tạo và Gán sự kiện ---
        document.addEventListener('DOMContentLoaded', function() {
            loadDropdownData();

            // Gán sự kiện cho các nút xóa
            document.querySelectorAll(".btn-remove-item").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = btn.dataset.id;
                    removeItem(id);
                });
            });
        });

        // Reset form khi đóng modal
        const addItemModal = document.getElementById('addItemModal');
        if (addItemModal) {
            addItemModal.addEventListener("hidden.bs.modal", () => {
                document.getElementById('addItemForm').reset();
                document.querySelectorAll("#addItemForm small").forEach(e => e.classList.add("d-none"));
                document.getElementById('AddItem_SoLuong').value = "1";
            });
        }
    </script>
</body>
</html>