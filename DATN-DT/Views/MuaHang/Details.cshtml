@* KHÔNG CẦN MODEL - DÙNG DYNAMIC *@
@{
    ViewData["Title"] = "Chi tiết sản phẩm";
    Layout = null;

    // Lấy dữ liệu từ ViewBag
    var product = ViewBag.ProductDetail as dynamic;
    var suggestedProducts = ViewBag.SuggestedProducts as IEnumerable<dynamic>;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Tech Phone</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* GIỮ NGUYÊN MÀU SẮC VÀ BIẾN NHƯ TRANG INDEX */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --dark-bg: #12121d;
            --card-bg: #36363f;
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
            --danger-color: #ff4757;
            --success-color: #28a745;
            --warning-color: #ffc107;
        }

        body {
            margin: 0;
            background-color: var(--dark-bg);
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        /* Header Styles - GIỐNG NHƯ TRANG INDEX */
        header {
            background-color: var(--card-bg);
            height: 100px;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 30px;
            z-index: 200;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .logo {
            cursor: pointer;
        }

            .logo img {
                height: 80px;
                width: auto;
            }

        .search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 2;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #2b2b33;
            border-radius: 25px;
            padding: 8px 20px;
            width: 600px;
            max-width: 80%;
            transition: width 0.3s;
        }

            .search-box input {
                background: transparent;
                border: none;
                color: white;
                padding: 8px 15px;
                width: 100%;
                font-size: 16px;
                outline: none;
            }

                .search-box input::placeholder {
                    color: #aaa;
                }

            .search-box button {
                background: transparent;
                border: none;
                color: #aaa;
                cursor: pointer;
                transition: color 0.3s;
            }

                .search-box button:hover {
                    color: #fff;
                }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 25px;
            flex: 1;
            justify-content: flex-end;
        }

        .cart-icon, .user-icon {
            position: relative;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .cart-icon i, .user-icon i {
                font-size: 32px;
                padding: 12px;
                border-radius: 50%;
                background-color: #2b2b33;
                width: 60px;
                height: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            }

            .cart-icon:hover i, .user-icon:hover i {
                color: #fff;
                background-color: #4a4a55;
                transform: scale(1.1);
            }

        .cart-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff4757;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #36363f;
        }

        /* Main Content - ĐIỀU CHỈNH ĐỂ GIỐNG INDEX */
        .main-content {
            min-height: calc(100vh - 100px);
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Breadcrumb */
        .breadcrumb {
            background-color: transparent;
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 16px;
        }

        .breadcrumb-item.active {
            color: var(--text-muted);
            font-size: 16px;
        }

        /* Product Detail Container - Liền một khối */
        .product-detail-container {
            background-color: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 40px;
        }

        .product-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        /* Hình ảnh sản phẩm - Cột trái */
        .product-images-section {
            padding: 40px;
            background-color: rgba(0, 0, 0, 0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-image {
            width: 100%;
            height: 450px;
            object-fit: contain;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .thumbnail-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 12px 0;
        }

        .thumbnail {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

            .thumbnail:hover,
            .thumbnail.active {
                border-color: var(--primary-color);
                transform: scale(1.08);
            }

        /* Thông tin sản phẩm - Cột phải */
        .product-info-section {
            padding: 40px;
        }

        .product-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-light);
            line-height: 1.3;
        }

        .product-brand {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hot-badge {
            background-color: var(--danger-color);
            color: white;
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Price Section */
        .price-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .current-price {
            font-size: 38px;
            font-weight: 700;
            color: white;
        }

        .original-price {
            text-decoration: line-through;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            margin-left: 15px;
        }

        .discount-percent {
            background-color: var(--success-color);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 15px;
        }

        .vat-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            margin-top: 8px;
        }

        /* Stock Info */
        .stock-info {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        .stock-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 17px;
        }

        .in-stock {
            color: var(--success-color);
        }

        .out-of-stock {
            color: var(--danger-color);
        }

        .sold-count {
            color: var(--text-muted);
            font-size: 16px;
        }

        /* Color Selection - MÀU CHỮ TRẮNG */
        .color-selection {
            margin-bottom: 25px;
        }

        .color-label {
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
            font-size: 18px;
            color: var(--text-light);
        }

        .color-options {
            display: flex;
            gap: 12px;
        }

        .color-option {
            padding: 12px 25px;
            border: 2px solid transparent;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            color: var(--text-light);
        }

            .color-option:hover,
            .color-option.selected {
                border-color: var(--primary-color);
                background-color: rgba(102, 126, 234, 0.15);
                transform: translateY(-2px);
            }

        /* Quantity Selector - MÀU CHỮ TRẮNG */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .quantity-label {
            font-weight: 600;
            font-size: 18px;
            color: var(--text-light);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantity-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-light);
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

            .quantity-btn:hover {
                background-color: rgba(0, 0, 0, 0.3);
            }

        .quantity-input {
            width: 70px;
            text-align: center;
            background-color: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-light);
            padding: 10px;
            border-radius: 10px;
            font-size: 18px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 18px 35px;
            border-radius: 12px;
            font-weight: 600;
            flex: 2;
            transition: all 0.3s;
            font-size: 18px;
        }

            .btn-primary:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            }

        .btn-secondary {
            background-color: rgba(0, 0, 0, 0.2);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 18px 35px;
            border-radius: 12px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s;
            font-size: 18px;
        }

            .btn-secondary:hover {
                background-color: rgba(102, 126, 234, 0.15);
                transform: translateY(-3px);
            }

        /* Thông số kỹ thuật - Nằm ngay dưới 2 cột, cùng container */
        .specifications-section {
            padding: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .spec-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .spec-label {
            color: var(--text-muted);
            font-size: 16px;
        }

        .spec-value {
            color: var(--text-light);
            font-weight: 500;
            font-size: 16px;
        }

        /* Phần Mô tả sản phẩm (nằm dưới cùng, cùng container) */
        .description-section {
            padding: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .description-content {
            line-height: 1.7;
            color: var(--text-muted);
            font-size: 16px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* Suggested Products */
        .suggested-products {
            margin-top: 40px;
        }

        .suggested-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 35px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .suggested-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .suggested-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid transparent;
        }

            .suggested-card:hover {
                transform: translateY(-8px);
                border-color: var(--primary-color);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            }

        .suggested-image {
            width: 100%;
            height: 220px;
            object-fit: contain;
            background-color: rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .suggested-info {
            padding: 20px;
        }

        .suggested-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-light);
            height: 50px;
            overflow: hidden;
        }

        .suggested-price {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 20px;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 120px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background-color: var(--card-bg);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        /* Alert Styles */
        .alert {
            border-radius: 12px;
            padding: 20px;
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Responsive Design */
        @@media (max-width: 1200px) {
            .search-box {
                width: 500px;
            }

            .suggested-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }

            .main-image {
                height: 400px;
            }
        }

        @@media (max-width: 992px) {
            header {
                flex-wrap: wrap;
                height: auto;
                padding: 15px;
            }

            .header-left {
                width: 100%;
                margin-bottom: 15px;
                justify-content: space-between;
            }

            .search-container {
                order: 3;
                width: 100%;
                margin-top: 15px;
            }

            .search-box {
                width: 100%;
                max-width: 100%;
            }

            .header-actions {
                width: auto;
                margin-top: 15px;
                gap: 15px;
            }

            .cart-icon i, .user-icon i {
                font-size: 28px;
                width: 50px;
                height: 50px;
            }

            .cart-count {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }

            .product-detail-grid {
                grid-template-columns: 1fr;
            }

            .product-images-section {
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .product-title {
                font-size: 28px;
            }

            .current-price {
                font-size: 32px;
            }

            .spec-grid {
                grid-template-columns: 1fr;
            }

            .main-image {
                height: 350px;
            }

            .thumbnail {
                width: 70px;
                height: 70px;
            }
        }

        @@media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }

            .product-images-section,
            .product-info-section,
            .specifications-section,
            .description-section {
                padding: 20px;
            }

            .main-image {
                height: 300px;
            }

            .product-title {
                font-size: 24px;
            }

            .current-price {
                font-size: 28px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .thumbnail {
                width: 60px;
                height: 60px;
            }

            .suggested-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .suggested-title {
                font-size: 24px;
            }
        }

        @@media (max-width: 576px) {
            .main-image {
                height: 250px;
            }

            .product-title {
                font-size: 22px;
            }

            .current-price {
                font-size: 24px;
            }

            .stock-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .suggested-grid {
                grid-template-columns: 1fr;
            }

            .product-brand {
                font-size: 18px;
            }

            .btn-primary,
            .btn-secondary {
                padding: 15px 25px;
                font-size: 16px;
            }

            .thumbnail {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- Header - GIỐNG NHƯ TRANG INDEX -->
    <header>
        <div class="header-left">
            <!-- Logo -->
            <div class="logo" onclick="goToHomePage()">
                <img src="~/ImgResource/LogoPhoneTech.png" alt="Logo PhoneTech" />
            </div>

            <!-- Search Box ở giữa -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" placeholder="Tìm kiếm sản phẩm..." id="searchInput">
                    <button onclick="searchProducts()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- User Menu bên phải -->
        <div class="header-actions">
            <div class="cart-icon" onclick="goToCartPage()">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cartCount">0</span>
            </div>
            <div class="user-icon" onclick="goToUserProfile()">
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/MuaHang">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/MuaHang">Sản phẩm</a></li>
                <li class="breadcrumb-item active">@(product?.TenModel ?? "Sản phẩm")</li>
            </ol>
        </nav>

        @if (!string.IsNullOrEmpty(TempData["ErrorMessage"] as string))
        {
            <div class="alert alert-danger" role="alert">
                @TempData["ErrorMessage"]
            </div>
        }
        else if (product == null)
        {
            <div class="alert alert-warning" role="alert">
                Không tìm thấy thông tin sản phẩm
            </div>
        }
        else
        {
            <!-- Product Detail Container - Tất cả trong một khối -->
            <div class="product-detail-container">
                <!-- Grid 2 cột trên cùng -->
                <div class="product-detail-grid">
                    <!-- Hình ảnh sản phẩm - Cột trái -->
                    <div class="product-images-section">
                        @if (product.AnhSanPhams != null && (product.AnhSanPhams as IEnumerable<dynamic>).Any())
                        {
                            var firstImage = (product.AnhSanPhams as IEnumerable<dynamic>)?.FirstOrDefault();
                            <img id="mainImage" src="@firstImage?.DuongDan"
                                 alt="@product.TenModel" class="main-image"
                                 onerror="this.src='/ImgResource/default-product.jpg'">

                            <div class="thumbnail-container">
                                @foreach (var image in product.AnhSanPhams as IEnumerable<dynamic>)
                                {
                                    <img src="@image.DuongDan" alt="@product.TenModel"
                                         class="thumbnail @(image == firstImage ? "active" : "")"
                                         onclick="changeMainImage('@image.DuongDan', this)"
                                         onerror="this.src='/ImgResource/default-product.jpg'">
                                }
                            </div>
                        }
                        else
                        {
                            <img id="mainImage" src="/ImgResource/default-product.jpg"
                                 alt="@product.TenModel" class="main-image">
                        }
                    </div>

                    <!-- Thông tin sản phẩm - Cột phải -->
                    <div class="product-info-section">
                        <!-- Product Title & Brand -->
                        <h1 class="product-title">@product.TenModel</h1>
                        <div class="product-brand">
                            <i class="fas fa-tag"></i> @product.TenThuongHieu
                            @if (product.IsHot)
                            {
                                <span class="hot-badge">HOT</span>
                            }
                        </div>

                        <!-- Price Section -->
                        <div class="price-section">
                            <div class="d-flex align-items-center flex-wrap">
                                <span class="current-price">
                                    @FormatPrice(product.GiaBan)
                                </span>
                                @if (product.GiaGoc > product.GiaBan)
                                {
                                    <span class="original-price">
                                        @FormatPrice(product.GiaGoc)
                                    </span>
                                    <span class="discount-percent">
                                        -@(Math.Round((product.GiaGoc - product.GiaBan) / product.GiaGoc * 100))%
                                    </span>
                                }
                            </div>
                            @if (product.VAT > 0)
                            {
                                <div class="vat-info">
                                    <i class="fas fa-receipt"></i> Đã bao gồm VAT @(product.VAT)%
                                </div>
                            }
                        </div>

                        <!-- Stock Information -->
                        <div class="stock-info">
                            <div class="stock-badge @(product.SoLuongTon > 0 ? "in-stock" : "out-of-stock")">
                                <i class="fas fa-@(product.SoLuongTon > 0 ? "check-circle" : "times-circle")"></i>
                                @if (product.SoLuongTon > 0)
                                {
                                    <span>Còn hàng: @product.SoLuongTon sản phẩm</span>
                                }
                                else
                                {
                                    <span>Hết hàng</span>
                                }
                            </div>
                            <div class="sold-count">
                                <i class="fas fa-fire"></i> Đã bán: @product.SoLuongDaBan
                            </div>
                        </div>

                        <!-- Color Selection - MÀU CHỮ TRẮNG -->
                        <div class="color-selection">
                            <span class="color-label">Màu sắc:</span>
                            <div class="color-options">
                                <div class="color-option selected" onclick="selectColor(this)">
                                    @product.Mau
                                </div>
                            </div>
                        </div>

                        <!-- Quantity Selector - MÀU CHỮ TRẮNG -->
                        <div class="quantity-selector">
                            <span class="quantity-label">Số lượng:</span>
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="changeQuantity(-1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="quantity-input" id="quantity"
                                       value="1" min="1" max="@product.SoLuongTon"
                                @(product.SoLuongTon <= 0 ? "disabled" : "")>
                                <button class="quantity-btn" onclick="changeQuantity(1)"
                                @(product.SoLuongTon <= 0 ? "disabled" : "")>
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="addToCart()"
                            @(product.SoLuongTon <= 0 ? "disabled" : "")>
                                <i class="fas fa-shopping-cart"></i> Thêm vào giỏ hàng
                            </button>
                            <button class="btn btn-secondary" onclick="goToCartPage()"
                            @(product.SoLuongTon <= 0 ? "disabled" : "")>
                                <i class="fas fa-bolt"></i> Mua Hàng
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Thông số kỹ thuật - Nằm ngay dưới 2 cột, cùng container -->
                <div class="specifications-section">
                    <h3 class="section-title">
                        <i class="fas fa-microchip"></i> Thông số kỹ thuật
                    </h3>
                    <div class="spec-grid">
                        <div class="spec-item">
                            <span class="spec-label">Bộ nhớ trong:</span>
                            <span class="spec-value">@product.DungLuongROM</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">RAM:</span>
                            <span class="spec-value">@product.DungLuongRAM</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Pin:</span>
                            <span class="spec-value">@product.DungLuongPin</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Màn hình:</span>
                            <span class="spec-value">@product.KichThuocManHinh</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Camera trước:</span>
                            <span class="spec-value">@product.DoPhanGiaiCamTruoc</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Camera sau:</span>
                            <span class="spec-value">@product.DoPhanGiaiCamSau</span>
                        </div>
                        @if (!string.IsNullOrEmpty(product.CongNgheManHinh))
                        {
                            <div class="spec-item">
                                <span class="spec-label">Công nghệ màn hình:</span>
                                <span class="spec-value">@product.CongNgheManHinh</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(product.LoaiPin))
                        {
                            <div class="spec-item">
                                <span class="spec-label">Loại pin:</span>
                                <span class="spec-value">@product.LoaiPin</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(product.CongNgheSac))
                        {
                            <div class="spec-item">
                                <span class="spec-label">Công nghệ sạc:</span>
                                <span class="spec-value">@product.CongNgheSac</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Phần Mô tả sản phẩm (nằm dưới cùng, cùng container) -->
                <div class="description-section">
                    <h3 class="section-title"><i class="fas fa-info-circle"></i> Mô tả sản phẩm</h3>
                    <div class="description-content">
                        @if (!string.IsNullOrEmpty(product.MoTaSanPham))
                        {
                            @Html.Raw((product.MoTaSanPham as string)?.Replace("\n", "<br>"))
                        }
                        else
                        {
                            <p>Chưa có mô tả chi tiết cho sản phẩm này.</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Suggested Products -->
            @if (suggestedProducts != null && suggestedProducts.Any())
            {
                <div class="suggested-products">
                    <h3 class="suggested-title">
                        <i class="fas fa-random"></i> Sản phẩm liên quan
                    </h3>
                    <div class="suggested-grid">
                        @foreach (var suggestedProduct in suggestedProducts)
                        {
                            <div class="suggested-card" onclick="viewProductDetail(@suggestedProduct.IdModelSanPham)">
                                <img src="@suggestedProduct.AnhSanPham" alt="@suggestedProduct.TenModel"
                                     class="suggested-image"
                                     onerror="this.src='/ImgResource/default-product.jpg'">
                                <div class="suggested-info">
                                    <div class="suggested-name">@suggestedProduct.TenModel</div>
                                    <div class="suggested-price">@FormatPrice(suggestedProduct.GiaBan)</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // ========== GLOBAL VARIABLES
        let currentQuantity = 1;
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let productId = @(product?.IdModelSanPham ?? 0);
        let productName = '@Html.Raw(product?.TenModel?.Replace("'", "\\'") ?? "")';
        let productPrice = @(product?.GiaBan ?? 0);
        let productImage = '@(product?.AnhSanPhams != null && (product.AnhSanPhams as IEnumerable<dynamic>).Any() ? ((product.AnhSanPhams as IEnumerable<dynamic>)?.FirstOrDefault()?.DuongDan ?? "/ImgResource/default-product.jpg") : "/ImgResource/default-product.jpg")';
        let productStock = @(product?.SoLuongTon ?? 0);

        // ========== INITIALIZATION
        document.addEventListener('DOMContentLoaded', function () {
            updateCartCount();

            // Set max quantity based on stock
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
                quantityInput.max = productStock;
            }
        });

        // ========== IMAGE GALLERY
        function changeMainImage(src, element) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = src;

            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            element.classList.add('active');
        }

        // ========== QUANTITY MANAGEMENT
        function changeQuantity(delta) {
            const quantityInput = document.getElementById('quantity');
            let newQuantity = parseInt(quantityInput.value) + delta;

            // Validate min and max
            const maxQuantity = parseInt(quantityInput.max);
            const minQuantity = parseInt(quantityInput.min);

            if (newQuantity < minQuantity) newQuantity = minQuantity;
            if (newQuantity > maxQuantity) newQuantity = maxQuantity;

            quantityInput.value = newQuantity;
            currentQuantity = newQuantity;
        }

        // ========== CART MANAGEMENT
        async function addToCart() {
            const quantity = parseInt(document.getElementById('quantity').value);

            if (productId <= 0) {
                showToast('Sản phẩm không hợp lệ', 'danger');
                return;
            }

            if (quantity <= 0) {
                showToast('Vui lòng chọn số lượng hợp lệ', 'warning');
                return;
            }

            try {
                // Call API to add to cart (GioHang/AddToCart để lưu vào database)
                const response = await fetch('/GioHang/AddToCart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        IdModelSanPham: productId,
                        Quantity: quantity
                    })
                });

                const result = await response.json();

                if (result.Success) {
                    // Add to local cart for UI updates
                    const existingItem = cart.find(item => item.id === productId);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        cart.push({
                            id: productId,
                            name: productName,
                            price: productPrice,
                            image: productImage,
                            quantity: quantity
                        });
                    }

                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartCount();
                    showToast(result.Message || 'Đã thêm vào giỏ hàng thành công', 'success');
                } else {
                    // Thất bại: Hiển thị thông báo lỗi
                    if (response.status === 401) {
                        showToast('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng', 'warning');
                    } else {
                        showToast(result.Message || 'Không thể thêm sản phẩm vào giỏ hàng', 'danger');
                    }
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                // Fallback: Add to local cart only (tạm thời)
                const existingItem = cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({
                        id: productId,
                        name: productName,
                        price: productPrice,
                        image: productImage,
                        quantity: quantity
                    });
                }

                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartCount();
                showToast('Đã thêm vào giỏ hàng (tạm thời). Vui lòng đăng nhập để đồng bộ.', 'warning');
            }
        }

       

        // ========== NAVIGATION
        function goToHomePage() {
            window.location.href = '/MuaHang';
        }

        function goToCartPage() {
            window.location.href = '/GioHang/Cart';
        }

        function goToUserProfile() {
            window.location.href = '/UserProfile';
        }

        function viewProductDetail(productId) {
            window.location.href = `/MuaHang/Details/${productId}`;
        }

        // ========== SEARCH FUNCTION
        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm) {
                window.location.href = `/MuaHang?search=${encodeURIComponent(searchTerm)}`;
            }
        }

        // ========== UTILITY FUNCTIONS
        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        async function updateCartCount() {
            try {
                // Gọi API để lấy số lượng từ database
                const response = await fetch('/GioHang/GetCartCount');
                const result = await response.json();
                
                if (result.Success) {
                    const count = result.Count || 0;
                    document.getElementById('cartCount').textContent = count;
                    
                    // Nếu giỏ hàng trống trong database, xóa localStorage để đồng bộ
                    if (count === 0) {
                        cart = [];
                        localStorage.removeItem('cart');
                    } else {
                        // Đồng bộ localStorage với database (cập nhật cart từ API nếu cần)
                        // Tạm thời giữ localStorage để UI nhanh, nhưng số lượng hiển thị luôn từ database
                    }
                } else {
                    // Fallback: Đếm từ localStorage nếu API thất bại (chỉ khi API không thành công)
                    const count = cart.reduce((total, item) => total + item.quantity, 0);
                    document.getElementById('cartCount').textContent = count;
                }
            } catch (error) {
                console.error('Lỗi khi lấy số lượng giỏ hàng:', error);
                // Fallback: Đếm từ localStorage nếu có lỗi kết nối
                const count = cart.reduce((total, item) => total + item.quantity, 0);
                document.getElementById('cartCount').textContent = count;
            }
        }

        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function showToast(message, type = 'info') {
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} border-0`;
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                                <div class="d-flex">
                                    <div class="toast-body">
                                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : type === 'danger' ? 'fa-times-circle' : 'fa-info-circle'} me-2"></i>
                                        ${message}
                                    </div>
                                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                                            onclick="document.getElementById('${toastId}').remove()"></button>
                                </div>
                            `;

            const toastContainer = document.getElementById('toastContainer');
            toastContainer.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, 3000);
        }

        // Listen for quantity input changes
        const quantityInput = document.getElementById('quantity');
        if (quantityInput) {
            quantityInput.addEventListener('change', function (e) {
                let value = parseInt(e.target.value);
                const max = parseInt(e.target.max);
                const min = parseInt(e.target.min);

                if (isNaN(value) || value < min) value = min;
                if (value > max) value = max;

                e.target.value = value;
                currentQuantity = value;
            });
        }

        // Listen for Enter key in search
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });
    </script>
</body>
</html>

@functions {
    public string FormatPrice(decimal price)
    {
        return string.Format("{0:N0}", price);
    }
}